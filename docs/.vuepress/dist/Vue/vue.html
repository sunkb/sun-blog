<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ</title>
    <meta name="description" content="å‰ç«¯åšå®¢ä¹‹å®¶">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.1b45e88d.css" as="style"><link rel="preload" href="/assets/js/app.33c008d4.js" as="script"><link rel="preload" href="/assets/js/2.f6583267.js" as="script"><link rel="preload" href="/assets/js/15.5f8fabb6.js" as="script"><link rel="prefetch" href="/assets/js/10.029a3a95.js"><link rel="prefetch" href="/assets/js/11.c254ac84.js"><link rel="prefetch" href="/assets/js/12.b90513f5.js"><link rel="prefetch" href="/assets/js/13.31b150fc.js"><link rel="prefetch" href="/assets/js/14.1f821c0e.js"><link rel="prefetch" href="/assets/js/16.4e49ae2a.js"><link rel="prefetch" href="/assets/js/17.1c855a6b.js"><link rel="prefetch" href="/assets/js/18.a10f2c1b.js"><link rel="prefetch" href="/assets/js/19.196ac4bb.js"><link rel="prefetch" href="/assets/js/20.8281acf4.js"><link rel="prefetch" href="/assets/js/3.4ec713e1.js"><link rel="prefetch" href="/assets/js/4.b6f69170.js"><link rel="prefetch" href="/assets/js/5.2c36c48a.js"><link rel="prefetch" href="/assets/js/6.d20ed2a3.js"><link rel="prefetch" href="/assets/js/7.7ef12aec.js"><link rel="prefetch" href="/assets/js/8.e106a615.js"><link rel="prefetch" href="/assets/js/9.aa586946.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b45e88d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://q285gdauq.bkt.clouddn.com/sunligjt.jpg" alt="å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ" class="logo"> <span class="site-name can-hide">å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/JS/" class="nav-link">JSåŸºç¡€</a></div><div class="nav-item"><a href="/Vue/vue.html" class="nav-link router-link-exact-active router-link-active">Vue</a></div><div class="nav-item"><a href="/React/" class="nav-link">ReactåŠè§£</a></div><div class="nav-item"><a href="/Network/" class="nav-link">è®¡ç®—æœºç½‘ç»œ</a></div><div class="nav-item"><a href="/Browser/browser.html" class="nav-link">æµè§ˆå™¨</a></div><div class="nav-item"><a href="/Safety/safe.html" class="nav-link">ç½‘ç»œå®‰å…¨</a></div><div class="nav-item"><a href="/Performance/performance.html" class="nav-link">æ€§èƒ½ä¼˜åŒ–ç‚¹</a></div><div class="nav-item"><a href="/Datastruct/datastruct.html" class="nav-link">æ•°æ®ç»“æ„</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">ç®—æ³•</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/JS/" class="nav-link">JSåŸºç¡€</a></div><div class="nav-item"><a href="/Vue/vue.html" class="nav-link router-link-exact-active router-link-active">Vue</a></div><div class="nav-item"><a href="/React/" class="nav-link">ReactåŠè§£</a></div><div class="nav-item"><a href="/Network/" class="nav-link">è®¡ç®—æœºç½‘ç»œ</a></div><div class="nav-item"><a href="/Browser/browser.html" class="nav-link">æµè§ˆå™¨</a></div><div class="nav-item"><a href="/Safety/safe.html" class="nav-link">ç½‘ç»œå®‰å…¨</a></div><div class="nav-item"><a href="/Performance/performance.html" class="nav-link">æ€§èƒ½ä¼˜åŒ–ç‚¹</a></div><div class="nav-item"><a href="/Datastruct/datastruct.html" class="nav-link">æ•°æ®ç»“æ„</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">ç®—æ³•</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Vue/vue.html#è„æ•°æ®æ£€æµ‹" class="sidebar-link">è„æ•°æ®æ£€æµ‹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#æ•°æ®åŠ«æŒ" class="sidebar-link">æ•°æ®åŠ«æŒ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#proxy-ä¸-object-defineproperty-å¯¹æ¯”" class="sidebar-link">Proxy ä¸ Object.defineProperty å¯¹æ¯”</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#ä¸ºä»€ä¹ˆéœ€è¦-virtual-dom" class="sidebar-link">ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#virtual-dom-ç®—æ³•ç®€è¿°" class="sidebar-link">Virtual Dom ç®—æ³•ç®€è¿°</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#virtual-dom-ç®—æ³•å®ç°" class="sidebar-link">Virtual Dom ç®—æ³•å®ç°</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Vue/vue.html#æ ‘çš„é€’å½’" class="sidebar-link">æ ‘çš„é€’å½’</a></li><li class="sidebar-sub-header"><a href="/Vue/vue.html#åˆ¤æ–­å±æ€§çš„æ›´æ”¹" class="sidebar-link">åˆ¤æ–­å±æ€§çš„æ›´æ”¹</a></li><li class="sidebar-sub-header"><a href="/Vue/vue.html#åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°" class="sidebar-link">åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</a></li><li class="sidebar-sub-header"><a href="/Vue/vue.html#éå†å­å…ƒç´ æ‰“æ ‡è¯†" class="sidebar-link">éå†å­å…ƒç´ æ‰“æ ‡è¯†</a></li><li class="sidebar-sub-header"><a href="/Vue/vue.html#æ¸²æŸ“å·®å¼‚" class="sidebar-link">æ¸²æŸ“å·®å¼‚</a></li></ul></li><li><a href="/Vue/vue.html#æœ€å" class="sidebar-link">æœ€å</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾" class="sidebar-link">é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#è·¯ç”±æ³¨å†Œ" class="sidebar-link">è·¯ç”±æ³¨å†Œ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#vuerouter-å®ä¾‹åŒ–" class="sidebar-link">VueRouter å®ä¾‹åŒ–</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡" class="sidebar-link">åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#è·¯ç”±åˆå§‹åŒ–" class="sidebar-link">è·¯ç”±åˆå§‹åŒ–</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/vue.html#è·¯ç”±è·³è½¬" class="sidebar-link">è·¯ç”±è·³è½¬</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em> <strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <ul><li><a href="#mvvm">MVVM</a> <ul><li><a href="#%E8%84%8F%E6%95%B0%E6%8D%AE%E6%A3%80%E6%B5%8B">è„æ•°æ®æ£€æµ‹</a></li> <li><a href="#%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81">æ•°æ®åŠ«æŒ</a></li> <li><a href="#proxy-%E4%B8%8E-objectdefineproperty-%E5%AF%B9%E6%AF%94">Proxy ä¸ Object.defineProperty å¯¹æ¯”</a></li></ul></li> <li><a href="#%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86">è·¯ç”±åŸç†</a></li> <li><a href="#virtual-dom">Virtual Dom</a> <ul><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-virtual-dom">ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</a></li> <li><a href="#virtual-dom-%E7%AE%97%E6%B3%95%E7%AE%80%E8%BF%B0">Virtual Dom ç®—æ³•ç®€è¿°</a></li> <li><a href="#virtual-dom-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">Virtual Dom ç®—æ³•å®ç°</a> <ul><li><a href="#%E6%A0%91%E7%9A%84%E9%80%92%E5%BD%92">æ ‘çš„é€’å½’</a></li> <li><a href="#%E5%88%A4%E6%96%AD%E5%B1%9E%E6%80%A7%E7%9A%84%E6%9B%B4%E6%94%B9">åˆ¤æ–­å±æ€§çš„æ›´æ”¹</a></li> <li><a href="#%E5%88%A4%E6%96%AD%E5%88%97%E8%A1%A8%E5%B7%AE%E5%BC%82%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</a></li> <li><a href="#%E9%81%8D%E5%8E%86%E5%AD%90%E5%85%83%E7%B4%A0%E6%89%93%E6%A0%87%E8%AF%86">éå†å­å…ƒç´ æ‰“æ ‡è¯†</a></li> <li><a href="#%E6%B8%B2%E6%9F%93%E5%B7%AE%E5%BC%82">æ¸²æŸ“å·®å¼‚</a></li></ul></li> <li><a href="#%E6%9C%80%E5%90%8E">æœ€å</a></li></ul></li></ul> <h1 id="mvvm"><a href="#mvvm" aria-hidden="true" class="header-anchor">#</a> MVVM</h1> <p>MVVM ç”±ä»¥ä¸‹ä¸‰ä¸ªå†…å®¹ç»„æˆ</p> <ul><li>Viewï¼šç•Œé¢</li> <li>Modelï¼šæ•°æ®æ¨¡å‹</li> <li>ViewModelï¼šä½œä¸ºæ¡¥æ¢è´Ÿè´£æ²Ÿé€š View å’Œ Model</li></ul> <p>åœ¨ JQuery æ—¶æœŸï¼Œå¦‚æœéœ€è¦åˆ·æ–° UI æ—¶ï¼Œéœ€è¦å…ˆå–åˆ°å¯¹åº”çš„ DOM å†æ›´æ–° UIï¼Œè¿™æ ·æ•°æ®å’Œä¸šåŠ¡çš„é€»è¾‘å°±å’Œé¡µé¢æœ‰å¼ºè€¦åˆã€‚</p> <p>åœ¨ MVVM ä¸­ï¼ŒUI æ˜¯é€šè¿‡æ•°æ®é©±åŠ¨çš„ï¼Œæ•°æ®ä¸€æ—¦æ”¹å˜å°±ä¼šç›¸åº”çš„åˆ·æ–°å¯¹åº”çš„ UIï¼ŒUI å¦‚æœæ”¹å˜ï¼Œä¹Ÿä¼šæ”¹å˜å¯¹åº”çš„æ•°æ®ã€‚è¿™ç§æ–¹å¼å°±å¯ä»¥åœ¨ä¸šåŠ¡å¤„ç†ä¸­åªå…³å¿ƒæ•°æ®çš„æµè½¬ï¼Œè€Œæ— éœ€ç›´æ¥å’Œé¡µé¢æ‰“äº¤é“ã€‚ViewModel åªå…³å¿ƒæ•°æ®å’Œä¸šåŠ¡çš„å¤„ç†ï¼Œä¸å…³å¿ƒ View å¦‚ä½•å¤„ç†æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒView å’Œ Model éƒ½å¯ä»¥ç‹¬ç«‹å‡ºæ¥ï¼Œä»»ä½•ä¸€æ–¹æ”¹å˜äº†ä¹Ÿä¸ä¸€å®šéœ€è¦æ”¹å˜å¦ä¸€æ–¹ï¼Œå¹¶ä¸”å¯ä»¥å°†ä¸€äº›å¯å¤ç”¨çš„é€»è¾‘æ”¾åœ¨ä¸€ä¸ª ViewModel ä¸­ï¼Œè®©å¤šä¸ª View å¤ç”¨è¿™ä¸ª ViewModelã€‚</p> <p>åœ¨ MVVM ä¸­ï¼Œæœ€æ ¸å¿ƒçš„ä¹Ÿå°±æ˜¯æ•°æ®åŒå‘ç»‘å®šï¼Œä¾‹å¦‚ Angluar çš„è„æ•°æ®æ£€æµ‹ï¼ŒVue ä¸­çš„æ•°æ®åŠ«æŒã€‚</p> <h2 id="è„æ•°æ®æ£€æµ‹"><a href="#è„æ•°æ®æ£€æµ‹" aria-hidden="true" class="header-anchor">#</a> è„æ•°æ®æ£€æµ‹</h2> <p>å½“è§¦å‘äº†æŒ‡å®šäº‹ä»¶åä¼šè¿›å…¥è„æ•°æ®æ£€æµ‹ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ <code>$digest</code> å¾ªç¯éå†æ‰€æœ‰çš„æ•°æ®è§‚å¯Ÿè€…ï¼Œåˆ¤æ–­å½“å‰å€¼æ˜¯å¦å’Œå…ˆå‰çš„å€¼æœ‰åŒºåˆ«ï¼Œå¦‚æœæ£€æµ‹åˆ°å˜åŒ–çš„è¯ï¼Œä¼šè°ƒç”¨ <code>$watch</code> å‡½æ•°ï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>$digest</code> å¾ªç¯ç›´åˆ°å‘ç°æ²¡æœ‰å˜åŒ–ã€‚å¾ªç¯è‡³å°‘ä¸ºäºŒæ¬¡ ï¼Œè‡³å¤šä¸ºåæ¬¡ã€‚</p> <p>è„æ•°æ®æ£€æµ‹è™½ç„¶å­˜åœ¨ä½æ•ˆçš„é—®é¢˜ï¼Œä½†æ˜¯ä¸å…³å¿ƒæ•°æ®æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼æ”¹å˜çš„ï¼Œéƒ½å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œä½†æ˜¯è¿™åœ¨ Vue ä¸­çš„åŒå‘ç»‘å®šæ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚å¹¶ä¸”è„æ•°æ®æ£€æµ‹å¯ä»¥å®ç°æ‰¹é‡æ£€æµ‹å‡ºæ›´æ–°çš„å€¼ï¼Œå†å»ç»Ÿä¸€æ›´æ–° UIï¼Œå¤§å¤§å‡å°‘äº†æ“ä½œ DOM çš„æ¬¡æ•°ã€‚æ‰€ä»¥ä½æ•ˆä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œè¿™å°±ä»è€…è§ä»æ™ºè€…è§æ™ºäº†ã€‚</p> <h2 id="æ•°æ®åŠ«æŒ"><a href="#æ•°æ®åŠ«æŒ" aria-hidden="true" class="header-anchor">#</a> æ•°æ®åŠ«æŒ</h2> <p>Vue å†…éƒ¨ä½¿ç”¨äº† <code>Object.defineProperty()</code> æ¥å®ç°åŒå‘ç»‘å®šï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥ç›‘å¬åˆ° <code>set</code> å’Œ <code>get</code> çš„äº‹ä»¶ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'yck'</span> <span class="token punctuation">}</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> data<span class="token punctuation">.</span>name <span class="token comment">// -&gt; get value</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'yyy'</span> <span class="token comment">// -&gt; change value</span>

<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ç±»å‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€’å½’å­å±æ€§</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change value'</span><span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šä»£ç ç®€å•çš„å®ç°äº†å¦‚ä½•ç›‘å¬æ•°æ®çš„ <code>set</code> å’Œ <code>get</code> çš„äº‹ä»¶ï¼Œä½†æ˜¯ä»…ä»…å¦‚æ­¤æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦åœ¨é€‚å½“çš„æ—¶å€™ç»™å±æ€§æ·»åŠ å‘å¸ƒè®¢é˜…</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {{name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div><p>åœ¨è§£æå¦‚ä¸Šæ¨¡æ¿ä»£ç æ—¶ï¼Œé‡åˆ° <code>{{name}}</code> å°±ä¼šç»™å±æ€§ <code>name</code> æ·»åŠ å‘å¸ƒè®¢é˜…ã€‚</p></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// é€šè¿‡ Dep è§£è€¦</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// sub æ˜¯ Watcher å®ä¾‹</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// å…¨å±€å±æ€§ï¼Œé€šè¿‡è¯¥å±æ€§é…ç½® Watcher</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°† Dep.target æŒ‡å‘è‡ªå·±</span>
    <span class="token comment">// ç„¶åè§¦å‘å±æ€§çš„ getter æ·»åŠ ç›‘å¬</span>
    <span class="token comment">// æœ€åå°† Dep.target ç½®ç©º</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å¾—æ–°å€¼</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span>
    <span class="token comment">// è°ƒç”¨ update æ–¹æ³•æ›´æ–° Dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'yck'</span> <span class="token punctuation">}</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment">// æ¨¡æ‹Ÿè§£æåˆ° `{{name}}` è§¦å‘çš„æ“ä½œ</span>
<span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span>
<span class="token comment">// update Dom innerText</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'yyy'</span> 
</code></pre></div><p>æ¥ä¸‹æ¥,å¯¹ <code>defineReactive</code> å‡½æ•°è¿›è¡Œæ”¹é€ </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€’å½’å­å±æ€§</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token keyword">let</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value'</span><span class="token punctuation">)</span>
      <span class="token comment">// å°† Watcher æ·»åŠ åˆ°è®¢é˜…</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dp<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change value'</span><span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
      <span class="token comment">// æ‰§è¡Œ watcher çš„ update æ–¹æ³•</span>
      dp<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„åŒå‘ç»‘å®šï¼Œæ ¸å¿ƒæ€è·¯å°±æ˜¯æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å±æ€§çš„ getter æ¥å®ç°å‘å¸ƒè®¢é˜…çš„æ·»åŠ ã€‚</p> <h2 id="proxy-ä¸-object-defineproperty-å¯¹æ¯”"><a href="#proxy-ä¸-object-defineproperty-å¯¹æ¯”" aria-hidden="true" class="header-anchor">#</a> Proxy ä¸ Object.defineProperty å¯¹æ¯”</h2> <p><code>Object.defineProperty</code> è™½ç„¶å·²ç»èƒ½å¤Ÿå®ç°åŒå‘ç»‘å®šäº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯æœ‰ç¼ºé™·çš„ã€‚</p> <ol><li>åªèƒ½å¯¹å±æ€§è¿›è¡Œæ•°æ®åŠ«æŒï¼Œæ‰€ä»¥éœ€è¦æ·±åº¦éå†æ•´ä¸ªå¯¹è±¡</li> <li>å¯¹äºæ•°ç»„ä¸èƒ½ç›‘å¬åˆ°æ•°æ®çš„å˜åŒ–</li></ol> <p>è™½ç„¶ Vue ä¸­ç¡®å®èƒ½æ£€æµ‹åˆ°æ•°ç»„æ•°æ®çš„å˜åŒ–ï¼Œä½†æ˜¯å…¶å®æ˜¯ä½¿ç”¨äº† hack çš„åŠæ³•ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯æœ‰ç¼ºé™·çš„ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>
<span class="token comment">// hack ä»¥ä¸‹å‡ ä¸ªå‡½æ•°</span>
<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å¾—åŸç”Ÿå‡½æ•°</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨åŸç”Ÿå‡½æ•°</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment">// è§¦å‘æ›´æ–°</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>åè§‚ Proxy å°±æ²¡ä»¥ä¸Šçš„é—®é¢˜ï¼ŒåŸç”Ÿæ”¯æŒç›‘å¬æ•°ç»„å˜åŒ–ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥å¯¹æ•´ä¸ªå¯¹è±¡è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥ Vue ä¹Ÿå°†åœ¨ä¸‹ä¸ªå¤§ç‰ˆæœ¬ä¸­ä½¿ç”¨ Proxy æ›¿æ¢ Object.defineProperty</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">onWatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> setBind<span class="token punctuation">,</span> getLogger</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getLogger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setBind</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> value
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">onWatch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> v
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Get '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>property<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// bind `value` to `2`</span>
p<span class="token punctuation">.</span>a <span class="token comment">// -&gt; Get 'a' = 2</span>
</code></pre></div><h1 id="è·¯ç”±åŸç†"><a href="#è·¯ç”±åŸç†" aria-hidden="true" class="header-anchor">#</a> è·¯ç”±åŸç†</h1> <p>å‰ç«¯è·¯ç”±å®ç°èµ·æ¥å…¶å®å¾ˆç®€å•ï¼Œæœ¬è´¨å°±æ˜¯ç›‘å¬ URL çš„å˜åŒ–ï¼Œç„¶ååŒ¹é…è·¯ç”±è§„åˆ™ï¼Œæ˜¾ç¤ºç›¸åº”çš„é¡µé¢ï¼Œå¹¶ä¸”æ— é¡»åˆ·æ–°ã€‚ç›®å‰å•é¡µé¢ä½¿ç”¨çš„è·¯ç”±å°±åªæœ‰ä¸¤ç§å®ç°æ–¹å¼</p> <ul><li>hash æ¨¡å¼</li> <li>history æ¨¡å¼</li></ul> <p><code>www.test.com/#/</code> å°±æ˜¯ Hash URLï¼Œå½“ <code>#</code> åé¢çš„å“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¼šå‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ <code>hashchange</code> äº‹ä»¶æ¥ç›‘å¬åˆ° URL çš„å˜åŒ–ï¼Œä»è€Œè¿›è¡Œè·³è½¬é¡µé¢ã€‚</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042512.png" alt=""></p> <p>History æ¨¡å¼æ˜¯ HTML5 æ–°æ¨å‡ºçš„åŠŸèƒ½ï¼Œæ¯”ä¹‹ Hash URL æ›´åŠ ç¾è§‚</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042514.png" alt=""></p> <h1 id="virtual-dom"><a href="#virtual-dom" aria-hidden="true" class="header-anchor">#</a> Virtual Dom</h1> <p><a href="https://github.com/KieSun/My-wheels/tree/master/Virtual%20Dom" target="_blank" rel="noopener noreferrer">ä»£ç åœ°å€<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="ä¸ºä»€ä¹ˆéœ€è¦-virtual-dom"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-virtual-dom" aria-hidden="true" class="header-anchor">#</a> ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</h2> <p>ä¼—æ‰€å‘¨çŸ¥ï¼Œæ“ä½œ DOM æ˜¯å¾ˆè€—è´¹æ€§èƒ½çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘é€šè¿‡ JS å¯¹è±¡æ¥æ¨¡æ‹Ÿ DOM å¯¹è±¡ï¼Œæ¯•ç«Ÿæ“ä½œ JS å¯¹è±¡æ¯”æ“ä½œ DOM çœæ—¶çš„å¤šã€‚</p> <p>ä¸¾ä¸ªä¾‹å­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å‡è®¾è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ª ulï¼Œå…¶ä¸­åŒ…å«äº† 5 ä¸ª li</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
<span class="token comment">// è¿™é‡Œæ›¿æ¢ä¸Šé¢çš„ li</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre></div><p>ä»ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±å¯ä»¥çœ‹å‡ºå…ˆå‰çš„ ul ä¸­çš„ç¬¬ä¸‰ä¸ª li è¢«ç§»é™¤äº†ï¼Œå››äº”æ›¿æ¢äº†ä½ç½®ã€‚</p> <p>å¦‚æœä»¥ä¸Šæ“ä½œå¯¹åº”åˆ° DOM ä¸­ï¼Œé‚£ä¹ˆå°±æ˜¯ä»¥ä¸‹ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åˆ é™¤ç¬¬ä¸‰ä¸ª li</span>
ul<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// å°†ç¬¬å››ä¸ª li å’Œç¬¬äº”ä¸ªäº¤æ¢ä½ç½®</span>
<span class="token keyword">let</span> fromNode <span class="token operator">=</span> ul<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
</code></pre></div><p>å½“ç„¶åœ¨å®é™…æ“ä½œä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªæ ‡è¯†ï¼Œä½œä¸ºåˆ¤æ–­æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹çš„ä¾æ®ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯ Vue å’Œ React ä¸­å®˜æ–¹æ¨èåˆ—è¡¨é‡Œçš„èŠ‚ç‚¹ä½¿ç”¨å”¯ä¸€çš„ <code>key</code> æ¥ä¿è¯æ€§èƒ½ã€‚</p> <p>é‚£ä¹ˆæ—¢ç„¶ DOM å¯¹è±¡å¯ä»¥é€šè¿‡ JS å¯¹è±¡æ¥æ¨¡æ‹Ÿï¼Œåä¹‹ä¹Ÿå¯ä»¥é€šè¿‡ JS å¯¹è±¡æ¥æ¸²æŸ“å‡ºå¯¹åº”çš„ DOM</p> <p>ä»¥ä¸‹æ˜¯ä¸€ä¸ª JS å¯¹è±¡æ¨¡æ‹Ÿ DOM å¯¹è±¡çš„ç®€å•å®ç°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param {String} tag 'div'
   * @param {Object} props { class: 'item' }
   * @param {Array} children [ Element1, 'text']
   * @param {String} key option
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> children
      <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
  <span class="token punctuation">}</span>
  <span class="token comment">// æ¸²æŸ“</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key
    <span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token keyword">return</span> root
  <span class="token punctuation">}</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹</span>
  <span class="token function">_createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> child<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡ tag åˆ›å»ºèŠ‚ç‚¹</span>
    <span class="token keyword">let</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®èŠ‚ç‚¹å±æ€§</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é€’å½’æ·»åŠ å­èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      child<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> child
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span>
            element<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>key
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          child <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> el
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="virtual-dom-ç®—æ³•ç®€è¿°"><a href="#virtual-dom-ç®—æ³•ç®€è¿°" aria-hidden="true" class="header-anchor">#</a> Virtual Dom ç®—æ³•ç®€è¿°</h2> <p>æ—¢ç„¶æˆ‘ä»¬å·²ç»é€šè¿‡ JS æ¥æ¨¡æ‹Ÿå®ç°äº† DOMï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„éš¾ç‚¹å°±åœ¨äºå¦‚ä½•åˆ¤æ–­æ—§çš„å¯¹è±¡å’Œæ–°çš„å¯¹è±¡ä¹‹é—´çš„å·®å¼‚ã€‚</p> <p>DOM æ˜¯å¤šå‰æ ‘çš„ç»“æ„ï¼Œå¦‚æœéœ€è¦å®Œæ•´çš„å¯¹æ¯”ä¸¤é¢—æ ‘çš„å·®å¼‚ï¼Œé‚£ä¹ˆéœ€è¦çš„æ—¶é—´å¤æ‚åº¦ä¼šæ˜¯ O(n ^ 3)ï¼Œè¿™ä¸ªå¤æ‚åº¦è‚¯å®šæ˜¯ä¸èƒ½æ¥å—çš„ã€‚äºæ˜¯ React å›¢é˜Ÿä¼˜åŒ–äº†ç®—æ³•ï¼Œå®ç°äº† O(n) çš„å¤æ‚åº¦æ¥å¯¹æ¯”å·®å¼‚ã€‚</p> <p>å®ç° O(n) å¤æ‚åº¦çš„å…³é”®å°±æ˜¯åªå¯¹æ¯”åŒå±‚çš„èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯è·¨å±‚å¯¹æ¯”ï¼Œè¿™ä¹Ÿæ˜¯è€ƒè™‘åˆ°åœ¨å®é™…ä¸šåŠ¡ä¸­å¾ˆå°‘ä¼šå»è·¨å±‚çš„ç§»åŠ¨ DOM å…ƒç´ ã€‚</p> <p>æ‰€ä»¥åˆ¤æ–­å·®å¼‚çš„ç®—æ³•å°±åˆ†ä¸ºäº†ä¸¤æ­¥</p> <ul><li>é¦–å…ˆä»ä¸Šè‡³ä¸‹ï¼Œä»å·¦å¾€å³éå†å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ ‘çš„æ·±åº¦éå†ï¼Œè¿™ä¸€æ­¥ä¸­ä¼šç»™æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ç´¢å¼•ï¼Œä¾¿äºæœ€åæ¸²æŸ“å·®å¼‚</li> <li>ä¸€æ—¦èŠ‚ç‚¹æœ‰å­å…ƒç´ ï¼Œå°±å»åˆ¤æ–­å­å…ƒç´ æ˜¯å¦æœ‰ä¸åŒ</li></ul> <h2 id="virtual-dom-ç®—æ³•å®ç°"><a href="#virtual-dom-ç®—æ³•å®ç°" aria-hidden="true" class="header-anchor">#</a> Virtual Dom ç®—æ³•å®ç°</h2> <h3 id="æ ‘çš„é€’å½’"><a href="#æ ‘çš„é€’å½’" aria-hidden="true" class="header-anchor">#</a> æ ‘çš„é€’å½’</h3> <p>é¦–å…ˆæˆ‘ä»¬æ¥å®ç°æ ‘çš„é€’å½’ç®—æ³•ï¼Œåœ¨å®ç°è¯¥ç®—æ³•å‰ï¼Œå…ˆæ¥è€ƒè™‘ä¸‹ä¸¤ä¸ªèŠ‚ç‚¹å¯¹æ¯”ä¼šæœ‰å‡ ç§æƒ…å†µ</p> <ol><li>æ–°çš„èŠ‚ç‚¹çš„ <code>tagName</code> æˆ–è€… <code>key</code> å’Œæ—§çš„ä¸åŒï¼Œè¿™ç§æƒ…å†µä»£è¡¨éœ€è¦æ›¿æ¢æ—§çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¹Ÿä¸å†éœ€è¦éå†æ–°æ—§èŠ‚ç‚¹çš„å­å…ƒç´ äº†ï¼Œå› ä¸ºæ•´ä¸ªæ—§èŠ‚ç‚¹éƒ½è¢«åˆ æ‰äº†</li> <li>æ–°çš„èŠ‚ç‚¹çš„ <code>tagName</code> å’Œ <code>key</code>ï¼ˆå¯èƒ½éƒ½æ²¡æœ‰ï¼‰å’Œæ—§çš„ç›¸åŒï¼Œå¼€å§‹éå†å­æ ‘</li> <li>æ²¡æœ‰æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åš</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> StateEnums<span class="token punctuation">,</span> isString<span class="token punctuation">,</span> move <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>
<span class="token keyword">import</span> Element <span class="token keyword">from</span> <span class="token string">'./element'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">oldDomTree<span class="token punctuation">,</span> newDomTree</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºè®°å½•å·®å¼‚</span>
  <span class="token keyword">let</span> pathchs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ä¸€å¼€å§‹çš„ç´¢å¼•ä¸º 0</span>
  <span class="token function">dfs</span><span class="token punctuation">(</span>oldDomTree<span class="token punctuation">,</span> newDomTree<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pathchs<span class="token punctuation">)</span>
  <span class="token keyword">return</span> pathchs
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºä¿å­˜å­æ ‘çš„æ›´æ”¹</span>
  <span class="token keyword">let</span> curPatches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// éœ€è¦åˆ¤æ–­ä¸‰ç§æƒ…å†µ</span>
  <span class="token comment">// 1.æ²¡æœ‰æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åš</span>
  <span class="token comment">// 2.æ–°çš„èŠ‚ç‚¹çš„ tagName å’Œ `key` å’Œæ—§çš„ä¸åŒï¼Œå°±æ›¿æ¢</span>
  <span class="token comment">// 3.æ–°çš„èŠ‚ç‚¹çš„ tagName å’Œ keyï¼ˆå¯èƒ½éƒ½æ²¡æœ‰ï¼‰ å’Œæ—§çš„ç›¸åŒï¼Œå¼€å§‹éå†å­æ ‘</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> newNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å±æ€§æ˜¯å¦å˜æ›´</span>
    <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">diffProps</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>length<span class="token punctuation">)</span> curPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">,</span> props <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// éå†å­æ ‘</span>
    <span class="token function">diffChildren</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// èŠ‚ç‚¹ä¸åŒï¼Œéœ€è¦æ›¿æ¢</span>
    curPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">,</span> node<span class="token punctuation">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>curPatches<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>curPatches<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> curPatches
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="åˆ¤æ–­å±æ€§çš„æ›´æ”¹"><a href="#åˆ¤æ–­å±æ€§çš„æ›´æ”¹" aria-hidden="true" class="header-anchor">#</a> åˆ¤æ–­å±æ€§çš„æ›´æ”¹</h3> <p>åˆ¤æ–­å±æ€§çš„æ›´æ”¹ä¹Ÿåˆ†ä¸‰ä¸ªæ­¥éª¤</p> <ol><li>éå†æ—§çš„å±æ€§åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªå±æ€§æ˜¯å¦è¿˜å­˜åœ¨äºæ–°çš„å±æ€§åˆ—è¡¨ä¸­</li> <li>éå†æ–°çš„å±æ€§åˆ—è¡¨ï¼Œåˆ¤æ–­ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½å­˜åœ¨çš„å±æ€§çš„å€¼æ˜¯å¦æœ‰å˜åŒ–</li> <li>åœ¨ç¬¬äºŒæ­¥ä¸­åŒæ—¶æŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§ä¸å­˜åœ¨ä¸æ—§çš„å±æ€§åˆ—åˆ—è¡¨ä¸­</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ Props åˆ†ä»¥ä¸‹ä¸‰æ­¥éª¤</span>
  <span class="token comment">// å…ˆéå† oldProps æŸ¥çœ‹æ˜¯å¦å­˜åœ¨åˆ é™¤çš„å±æ€§</span>
  <span class="token comment">// ç„¶åéå† newProps æŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§å€¼è¢«ä¿®æ”¹</span>
  <span class="token comment">// æœ€åæŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§æ–°å¢</span>
  <span class="token keyword">let</span> change <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        prop<span class="token punctuation">:</span> key
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prop <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          prop<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
          value<span class="token punctuation">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          prop<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
          value<span class="token punctuation">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> change
<span class="token punctuation">}</span>

</code></pre></div><h3 id="åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°"><a href="#åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°" aria-hidden="true" class="header-anchor">#</a> åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</h3> <p>è¿™ä¸ªç®—æ³•æ˜¯æ•´ä¸ª Virtual Dom ä¸­æœ€æ ¸å¿ƒçš„ç®—æ³•ï¼Œä¸”è®©æˆ‘ä¸€ä¸€ä¸ºä½ é“æ¥ã€‚
è¿™é‡Œçš„ä¸»è¦æ­¥éª¤å…¶å®å’Œåˆ¤æ–­å±æ€§å·®å¼‚æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸‰æ­¥</p> <ol><li>éå†æ—§çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦è¿˜å­˜åœ¨äºæ–°çš„èŠ‚ç‚¹åˆ—è¡¨ä¸­</li> <li>éå†æ–°çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„èŠ‚ç‚¹</li> <li>åœ¨ç¬¬äºŒæ­¥ä¸­åŒæ—¶åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æœ‰ç§»åŠ¨</li></ol> <p>PSï¼šè¯¥ç®—æ³•åªå¯¹æœ‰ <code>key</code> çš„èŠ‚ç‚¹åšå¤„ç†</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">listDiff</span><span class="token punctuation">(</span><span class="token parameter">oldList<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸ºäº†éå†æ–¹ä¾¿ï¼Œå…ˆå–å‡ºä¸¤ä¸ª list çš„æ‰€æœ‰ keys</span>
  <span class="token keyword">let</span> oldKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>oldList<span class="token punctuation">)</span>
  <span class="token keyword">let</span> newKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>newList<span class="token punctuation">)</span>
  <span class="token keyword">let</span> changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// ç”¨äºä¿å­˜å˜æ›´åçš„èŠ‚ç‚¹æ•°æ®</span>
  <span class="token comment">// ä½¿ç”¨è¯¥æ•°ç»„ä¿å­˜æœ‰ä»¥ä¸‹å¥½å¤„</span>
  <span class="token comment">// 1.å¯ä»¥æ­£ç¡®è·å¾—è¢«åˆ é™¤èŠ‚ç‚¹ç´¢å¼•</span>
  <span class="token comment">// 2.äº¤æ¢èŠ‚ç‚¹ä½ç½®åªéœ€è¦æ“ä½œä¸€é DOM</span>
  <span class="token comment">// 3.ç”¨äº `diffChildren` å‡½æ•°ä¸­çš„åˆ¤æ–­ï¼Œåªéœ€è¦éå†</span>
  <span class="token comment">// ä¸¤ä¸ªæ ‘ä¸­éƒ½å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œè€Œå¯¹äºæ–°å¢æˆ–è€…åˆ é™¤çš„èŠ‚ç‚¹æ¥è¯´ï¼Œå®Œå…¨æ²¡å¿…è¦</span>
  <span class="token comment">// å†å»åˆ¤æ–­ä¸€é</span>
  <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  oldList <span class="token operator">&amp;&amp;</span>
    oldList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token comment">// å¯»æ‰¾æ–°çš„ children ä¸­æ˜¯å¦å«æœ‰å½“å‰èŠ‚ç‚¹</span>
      <span class="token comment">// æ²¡æœ‰çš„è¯éœ€è¦åˆ é™¤</span>
      <span class="token keyword">let</span> index <span class="token operator">=</span> newKeys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// éå†å˜æ›´åçš„æ•°ç»„</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> list<span class="token punctuation">.</span>length
  <span class="token comment">// å› ä¸ºåˆ é™¤æ•°ç»„å…ƒç´ æ˜¯ä¼šæ›´æ”¹ç´¢å¼•çš„</span>
  <span class="token comment">// æ‰€æœ‰ä»åå¾€å‰åˆ å¯ä»¥ä¿è¯ç´¢å¼•ä¸å˜</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨ç¤ºéœ€è¦åˆ é™¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">,</span>
        index<span class="token punctuation">:</span> i
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// éå†æ–°çš„ listï¼Œåˆ¤æ–­æ˜¯å¦æœ‰èŠ‚ç‚¹æ–°å¢æˆ–ç§»åŠ¨</span>
  <span class="token comment">// åŒæ—¶ä¹Ÿå¯¹ `list` åšèŠ‚ç‚¹æ–°å¢å’Œç§»åŠ¨èŠ‚ç‚¹çš„æ“ä½œ</span>
  newList <span class="token operator">&amp;&amp;</span>
    newList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token comment">// å¯»æ‰¾æ—§çš„ children ä¸­æ˜¯å¦å«æœ‰å½“å‰èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> index <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token comment">// æ²¡æ‰¾åˆ°ä»£è¡¨æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">,</span>
          node<span class="token punctuation">:</span> item<span class="token punctuation">,</span>
          index<span class="token punctuation">:</span> i
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰¾åˆ°äº†ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">,</span>
            <span class="token keyword">from</span><span class="token punctuation">:</span> index<span class="token punctuation">,</span>
            to<span class="token punctuation">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token function">move</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> index<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> text
  list <span class="token operator">&amp;&amp;</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token punctuation">}</span>
      keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> keys
<span class="token punctuation">}</span>
</code></pre></div><h3 id="éå†å­å…ƒç´ æ‰“æ ‡è¯†"><a href="#éå†å­å…ƒç´ æ‰“æ ‡è¯†" aria-hidden="true" class="header-anchor">#</a> éå†å­å…ƒç´ æ‰“æ ‡è¯†</h3> <p>å¯¹äºè¿™ä¸ªå‡½æ•°æ¥è¯´ï¼Œä¸»è¦åŠŸèƒ½å°±ä¸¤ä¸ª</p> <ol><li>åˆ¤æ–­ä¸¤ä¸ªåˆ—è¡¨å·®å¼‚</li> <li>ç»™èŠ‚ç‚¹æ‰“ä¸Šæ ‡è®°</li></ol> <p>æ€»ä½“æ¥è¯´ï¼Œè¯¥å‡½æ•°å®ç°çš„åŠŸèƒ½å¾ˆç®€å•</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">listDiff</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> changes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è®°å½•ä¸Šä¸€ä¸ªéå†è¿‡çš„èŠ‚ç‚¹</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  oldChild <span class="token operator">&amp;&amp;</span>
    oldChild<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> item <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>children
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">=</span>
          last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">let</span> keyIndex <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token keyword">let</span> node <span class="token operator">=</span> newChild<span class="token punctuation">[</span>keyIndex<span class="token punctuation">]</span>
        <span class="token comment">// åªéå†æ–°æ—§ä¸­éƒ½å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œå…¶ä»–æ–°å¢æˆ–è€…åˆ é™¤çš„æ²¡å¿…è¦éå†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">dfs</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> node<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> index <span class="token operator">+=</span> <span class="token number">1</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="æ¸²æŸ“å·®å¼‚"><a href="#æ¸²æŸ“å·®å¼‚" aria-hidden="true" class="header-anchor">#</a> æ¸²æŸ“å·®å¼‚</h3> <p>é€šè¿‡ä¹‹å‰çš„ç®—æ³•ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¾—å‡ºä¸¤ä¸ªæ ‘çš„å·®å¼‚äº†ã€‚æ—¢ç„¶çŸ¥é“äº†å·®å¼‚ï¼Œå°±éœ€è¦å±€éƒ¨å»æ›´æ–° DOM äº†ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Virtual Dom ç®—æ³•çš„æœ€åä¸€æ­¥éª¤</p> <p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä¸¤ä¸ªåŠŸèƒ½</p> <ol><li>æ·±åº¦éå†æ ‘ï¼Œå°†éœ€è¦åšå˜æ›´æ“ä½œçš„å–å‡ºæ¥</li> <li>å±€éƒ¨æ›´æ–° DOM</li></ol> <p>æ•´ä½“æ¥è¯´è¿™éƒ¨åˆ†ä»£ç è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patchs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> changes <span class="token operator">=</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  <span class="token keyword">let</span> childNodes <span class="token operator">=</span> node <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes
  <span class="token comment">// è¿™é‡Œçš„æ·±åº¦éå†å’Œ diff ä¸­æ˜¯ä¸€æ ·çš„</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childNodes<span class="token punctuation">)</span> index <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">&amp;&amp;</span> changes<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">changeDom</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> changes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childNodes <span class="token operator">&amp;&amp;</span> childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      index <span class="token operator">=</span>
        last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> patchs<span class="token punctuation">)</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">changeDom</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> changes<span class="token punctuation">,</span> noChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  changes <span class="token operator">&amp;&amp;</span>
    changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> change
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">:</span>
          <span class="token keyword">let</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> change
          props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">,</span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">:</span>
          node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">:</span>
          <span class="token keyword">let</span> dom
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dom <span class="token operator">=</span> change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">:</span>
          node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">:</span>
          <span class="token keyword">let</span> fromNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>from<span class="token punctuation">]</span>
          <span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>to<span class="token punctuation">]</span>
          <span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
          node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="æœ€å"><a href="#æœ€å" aria-hidden="true" class="header-anchor">#</a> æœ€å</h2> <p>Virtual Dom ç®—æ³•çš„å®ç°ä¹Ÿå°±æ˜¯ä»¥ä¸‹ä¸‰æ­¥</p> <ol><li>é€šè¿‡ JS æ¥æ¨¡æ‹Ÿåˆ›å»º DOM å¯¹è±¡</li> <li>åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„å·®å¼‚</li> <li>æ¸²æŸ“å·®å¼‚</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> test4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test4'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> test5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test5'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> test1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test4<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> test2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'11'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test5<span class="token punctuation">,</span> test4<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> root <span class="token operator">=</span> test1<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> pathchs <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>test1<span class="token punctuation">,</span> test2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pathchs<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'å¼€å§‹æ›´æ–°'</span><span class="token punctuation">)</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> pathchs<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ç»“æŸæ›´æ–°'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><p>å½“ç„¶ç›®å‰çš„å®ç°è¿˜ç•¥æ˜¾ç²—ç³™ï¼Œä½†æ˜¯å¯¹äºç†è§£ Virtual Dom ç®—æ³•æ¥è¯´å·²ç»æ˜¯å®Œå…¨è¶³å¤Ÿçš„äº†ã€‚</p> <ul><li><a href="#nexttick-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90">NextTick åŸç†åˆ†æ</a></li> <li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%88%86%E6%9E%90">ç”Ÿå‘½å‘¨æœŸåˆ†æ</a></li> <li><a href="#vuerouter-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">VueRouter æºç è§£æ</a> <ul><li><a href="#%E9%87%8D%E8%A6%81%E5%87%BD%E6%95%B0%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE">é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾</a></li> <li><a href="#%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C">è·¯ç”±æ³¨å†Œ</a></li> <li><a href="#vuerouter-%E5%AE%9E%E4%BE%8B%E5%8C%96">VueRouter å®ä¾‹åŒ–</a></li> <li><a href="#%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%8C%B9%E9%85%8D%E5%AF%B9%E8%B1%A1">åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡</a></li> <li><a href="#%E8%B7%AF%E7%94%B1%E5%88%9D%E5%A7%8B%E5%8C%96">è·¯ç”±åˆå§‹åŒ–</a></li> <li><a href="#%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC">è·¯ç”±è·³è½¬</a></li></ul></li></ul> <h1 id="nexttick-åŸç†åˆ†æ"><a href="#nexttick-åŸç†åˆ†æ" aria-hidden="true" class="header-anchor">#</a> NextTick åŸç†åˆ†æ</h1> <p><code>nextTick</code> å¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸‹æ¬¡ DOM æ›´æ–°å¾ªç¯ç»“æŸä¹‹åæ‰§è¡Œå»¶è¿Ÿå›è°ƒï¼Œç”¨äºè·å¾—æ›´æ–°åçš„ DOMã€‚</p> <p>åœ¨ Vue 2.4 ä¹‹å‰éƒ½æ˜¯ä½¿ç”¨çš„ microtasksï¼Œä½†æ˜¯ microtasks çš„ä¼˜å…ˆçº§è¿‡é«˜ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°æ¯”äº‹ä»¶å†’æ³¡æ›´å¿«çš„æƒ…å†µï¼Œä½†å¦‚æœéƒ½ä½¿ç”¨ macrotasks åˆå¯èƒ½ä¼šå‡ºç°æ¸²æŸ“çš„æ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥åœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œä¼šé»˜è®¤ä½¿ç”¨ microtasksï¼Œä½†åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä¼šä½¿ç”¨ macrotasksï¼Œæ¯”å¦‚ v-onã€‚</p> <p>å¯¹äºå®ç° macrotasks ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦èƒ½ä½¿ç”¨ <code>setImmediate</code> ï¼Œä¸èƒ½çš„è¯é™çº§ä¸º <code>MessageChannel</code> ï¼Œä»¥ä¸Šéƒ½ä¸è¡Œçš„è¯å°±ä½¿ç”¨ <code>setTimeout</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>setImmediate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token keyword">typeof</span> MessageChannel <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span><span class="token function">isNative</span><span class="token punctuation">(</span>MessageChannel<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// PhantomJS</span>
    MessageChannel<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object MessageChannelConstructor]'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2
  channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> flushCallbacks
  <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">/* istanbul ignore next */</span>
  <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>nextTick</code> åŒæ—¶ä¹Ÿæ”¯æŒ Promise çš„ä½¿ç”¨ï¼Œä¼šåˆ¤æ–­æ˜¯å¦å®ç°äº† Promise</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token punctuation">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _resolve
  <span class="token comment">// å°†å›è°ƒå‡½æ•°æ•´åˆè¿›ä¸€ä¸ªæ•°ç»„ä¸­</span>
  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token string">'nextTick'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_resolve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pending <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useMacroTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">macroTimerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">microTimerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨ Promise </span>
  <span class="token comment">// å¯ä»¥çš„è¯ç»™ _resolve èµ‹å€¼</span>
  <span class="token comment">// è¿™æ ·å›è°ƒå‡½æ•°å°±èƒ½ä»¥ promise çš„æ–¹å¼è°ƒç”¨</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      _resolve <span class="token operator">=</span> resolve
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="ç”Ÿå‘½å‘¨æœŸåˆ†æ"><a href="#ç”Ÿå‘½å‘¨æœŸåˆ†æ" aria-hidden="true" class="header-anchor">#</a> ç”Ÿå‘½å‘¨æœŸåˆ†æ</h1> <p>ç”Ÿå‘½å‘¨æœŸå‡½æ•°å°±æ˜¯ç»„ä»¶åœ¨åˆå§‹åŒ–æˆ–è€…æ•°æ®æ›´æ–°æ—¶ä¼šè§¦å‘çš„é’©å­å‡½æ•°ã€‚</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042515.png" alt=""></p> <p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ä»¥ä¸‹ä»£ç ï¼Œç”Ÿå‘½å‘¨æœŸå°±æ˜¯é€šè¿‡ <code>callHook</code> è°ƒç”¨çš„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span> <span class="token comment">// æ‹¿ä¸åˆ° props data</span>
    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> 
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥å‘ç°åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œ<code>beforeCreate</code> è°ƒç”¨çš„æ—¶å€™ï¼Œæ˜¯è·å–ä¸åˆ° props æˆ–è€… data ä¸­çš„æ•°æ®çš„ï¼Œå› ä¸ºè¿™äº›æ•°æ®çš„åˆå§‹åŒ–éƒ½åœ¨ <code>initState</code> ä¸­ã€‚</p> <p>æ¥ä¸‹æ¥ä¼šæ‰§è¡ŒæŒ‚è½½å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> mountComponent <span class="token punctuation">{</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>beforeMount</code> å°±æ˜¯åœ¨æŒ‚è½½å‰æ‰§è¡Œçš„ï¼Œç„¶åå¼€å§‹åˆ›å»º VDOM å¹¶æ›¿æ¢æˆçœŸå® DOMï¼Œæœ€åæ‰§è¡Œ <code>mounted</code> é’©å­ã€‚è¿™é‡Œä¼šæœ‰ä¸ªåˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœæ˜¯å¤–éƒ¨ <code>new Vue({})</code> çš„è¯ï¼Œä¸ä¼šå­˜åœ¨ <code>$vnode</code> ï¼Œæ‰€ä»¥ç›´æ¥æ‰§è¡Œ <code>mounted</code> é’©å­äº†ã€‚å¦‚æœæœ‰å­ç»„ä»¶çš„è¯ï¼Œä¼šé€’å½’æŒ‚è½½å­ç»„ä»¶ï¼Œåªæœ‰å½“æ‰€æœ‰å­ç»„ä»¶å…¨éƒ¨æŒ‚è½½å®Œæ¯•ï¼Œæ‰ä¼šæ‰§è¡Œæ ¹ç»„ä»¶çš„æŒ‚è½½é’©å­ã€‚</p> <p>æ¥ä¸‹æ¥æ˜¯æ•°æ®æ›´æ–°æ—¶ä¼šè°ƒç”¨çš„é’©å­å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushSchedulerQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      watcher<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è°ƒç”¨ beforeUpdate</span>
    <span class="token punctuation">}</span>
    id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id
    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// in dev build, check and stop circular updates.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_UPDATE_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token string">'You may have an infinite update loop '</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>user
              <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">in watcher with expression &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
              <span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">in a component render function.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          watcher<span class="token punctuation">.</span>vm
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">callUpdatedHooks</span><span class="token punctuation">(</span>updatedQueue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">callUpdatedHooks</span><span class="token punctuation">(</span><span class="token parameter">queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> watcher<span class="token punctuation">.</span>vm
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher <span class="token operator">===</span> watcher <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'updated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šå›¾è¿˜æœ‰ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸæ²¡æœ‰è¯´ï¼Œåˆ†åˆ«ä¸º <code>activated</code> å’Œ <code>deactivated</code> ï¼Œè¿™ä¸¤ä¸ªé’©å­å‡½æ•°æ˜¯ <code>keep-alive</code> ç»„ä»¶ç‹¬æœ‰çš„ã€‚ç”¨ <code>keep-alive</code> åŒ…è£¹çš„ç»„ä»¶åœ¨åˆ‡æ¢æ—¶ä¸ä¼šè¿›è¡Œé”€æ¯ï¼Œè€Œæ˜¯ç¼“å­˜åˆ°å†…å­˜ä¸­å¹¶æ‰§è¡Œ <code>deactivated</code> é’©å­å‡½æ•°ï¼Œå‘½ä¸­ç¼“å­˜æ¸²æŸ“åä¼šæ‰§è¡Œ <code>actived</code> é’©å­å‡½æ•°ã€‚</p> <p>æœ€åå°±æ˜¯é”€æ¯ç»„ä»¶çš„é’©å­å‡½æ•°äº†</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$destroy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeDestroy'</span><span class="token punctuation">)</span>
  vm<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// remove self from parent</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> vm<span class="token punctuation">.</span>$parent
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">remove</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$children<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// teardown watchers</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// remove reference from data ob</span>
  <span class="token comment">// frozen object may not have observer.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>vmCount<span class="token operator">--</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// call the last hook...</span>
  vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// invoke destroy hooks on current rendered tree</span>
  vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// fire destroyed hook</span>
  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'destroyed'</span><span class="token punctuation">)</span>
  <span class="token comment">// turn off all instance listeners.</span>
  vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// remove __vue__ reference</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// release circular reference (#6759)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ‰§è¡Œé”€æ¯æ“ä½œå‰ä¼šè°ƒç”¨ <code>beforeDestroy</code> é’©å­å‡½æ•°ï¼Œç„¶åè¿›è¡Œä¸€ç³»åˆ—çš„é”€æ¯æ“ä½œï¼Œå¦‚æœæœ‰å­ç»„ä»¶çš„è¯ï¼Œä¹Ÿä¼šé€’å½’é”€æ¯å­ç»„ä»¶ï¼Œæ‰€æœ‰å­ç»„ä»¶éƒ½é”€æ¯å®Œæ¯•åæ‰ä¼šæ‰§è¡Œæ ¹ç»„ä»¶çš„ <code>destroyed</code> é’©å­å‡½æ•°ã€‚</p> <h1 id="vuerouter-æºç è§£æ"><a href="#vuerouter-æºç è§£æ" aria-hidden="true" class="header-anchor">#</a> VueRouter æºç è§£æ</h1> <h2 id="é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾"><a href="#é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾" aria-hidden="true" class="header-anchor">#</a> é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾</h2> <p>ä»¥ä¸‹æ€ç»´å¯¼å›¾ç½—åˆ—äº†æºç ä¸­é‡è¦çš„ä¸€äº›å‡½æ•°
<img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042517.png" alt=""></p> <h2 id="è·¯ç”±æ³¨å†Œ"><a href="#è·¯ç”±æ³¨å†Œ" aria-hidden="true" class="header-anchor">#</a> è·¯ç”±æ³¨å†Œ</h2> <p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ¨èå¤§å®¶ clone ä¸€ä»½æºç å¯¹ç…§ç€çœ‹ã€‚å› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œå‡½æ•°é—´çš„è·³è½¬ä¹Ÿå¾ˆå¤šã€‚</p> <p>ä½¿ç”¨è·¯ç”±ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨ <code>Vue.use(VueRouter)</code>ï¼Œè¿™æ˜¯å› ä¸ºè®©æ’ä»¶å¯ä»¥ä½¿ç”¨ Vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initUse</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">plugin<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­é‡å¤å®‰è£…æ’ä»¶</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// æ’å…¥ Vue</span>
    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// ä¸€èˆ¬æ’ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ª install å‡½æ•°</span>
    <span class="token comment">// é€šè¿‡è¯¥å‡½æ•°è®©æ’ä»¶å¯ä»¥ä½¿ç”¨ Vue</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹ä¸‹ <code>install</code> å‡½æ•°çš„éƒ¨åˆ†å®ç°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç¡®ä¿ install è°ƒç”¨ä¸€æ¬¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>install<span class="token punctuation">.</span>installed <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token keyword">return</span>
  install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// æŠŠ Vue èµ‹å€¼ç»™å…¨å±€å˜é‡</span>
  _Vue <span class="token operator">=</span> Vue
  <span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> callVal<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç»™æ¯ä¸ªç»„ä»¶çš„é’©å­å‡½æ•°æ··å…¥å®ç°</span>
  <span class="token comment">// å¯ä»¥å‘ç°åœ¨ `beforeCreate` é’©å­æ‰§è¡Œæ—¶</span>
  <span class="token comment">// ä¼šåˆå§‹åŒ–è·¯ç”±</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤æ–­ç»„ä»¶æ˜¯å¦å­˜åœ¨ router å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åªåœ¨æ ¹ç»„ä»¶ä¸Šæœ‰</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¹è·¯ç”±è®¾ç½®ä¸ºè‡ªå·±</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
        <span class="token comment">// åˆå§‹åŒ–è·¯ç”±</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// å¾ˆé‡è¦ï¼Œä¸º _route å±æ€§å®ç°åŒå‘ç»‘å®š</span>
        <span class="token comment">// è§¦å‘ç»„ä»¶æ¸²æŸ“</span>
        Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”¨äº router-view å±‚çº§åˆ¤æ–­</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// å…¨å±€æ³¨å†Œç»„ä»¶ router-link å’Œ router-view</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> View<span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> Link<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯¹äºè·¯ç”±æ³¨å†Œæ¥è¯´ï¼Œæ ¸å¿ƒå°±æ˜¯è°ƒç”¨ <code>Vue.use(VueRouter)</code>ï¼Œä½¿å¾— VueRouter å¯ä»¥ä½¿ç”¨ Vueã€‚ç„¶åé€šè¿‡ Vue æ¥è°ƒç”¨ VueRouter çš„ <code>install</code> å‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­ï¼Œæ ¸å¿ƒå°±æ˜¯ç»™ç»„ä»¶æ··å…¥é’©å­å‡½æ•°å’Œå…¨å±€æ³¨å†Œä¸¤ä¸ªè·¯ç”±ç»„ä»¶ã€‚</p> <h2 id="vuerouter-å®ä¾‹åŒ–"><a href="#vuerouter-å®ä¾‹åŒ–" aria-hidden="true" class="header-anchor">#</a> VueRouter å®ä¾‹åŒ–</h2> <p>åœ¨å®‰è£…æ’ä»¶åï¼Œå¯¹ VueRouter è¿›è¡Œå®ä¾‹åŒ–ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;home&lt;/div&gt;'</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;foo&lt;/div&gt;'</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;bar&lt;/div&gt;'</span> <span class="token punctuation">}</span>

<span class="token comment">// 3. Create the router</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">'hash'</span><span class="token punctuation">,</span>
  base<span class="token punctuation">:</span> __dirname<span class="token punctuation">,</span>
  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// all paths are defined without the hash.</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>æ¥çœ‹ä¸€ä¸‹ VueRouter çš„æ„é€ å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// è·¯ç”±åŒ¹é…å¯¹è±¡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

    <span class="token comment">// æ ¹æ® mode é‡‡å–ä¸åŒçš„è·¯ç”±æ–¹å¼</span>
    <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span>
      mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'hash'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token punctuation">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token punctuation">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token punctuation">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>åœ¨å®ä¾‹åŒ– VueRouter çš„è¿‡ç¨‹ä¸­ï¼Œæ ¸å¿ƒæ˜¯åˆ›å»ºä¸€ä¸ªè·¯ç”±åŒ¹é…å¯¹è±¡ï¼Œå¹¶ä¸”æ ¹æ® mode æ¥é‡‡å–ä¸åŒçš„è·¯ç”±æ–¹å¼ã€‚</p> <h2 id="åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡"><a href="#åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡" aria-hidden="true" class="header-anchor">#</a> åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createMatcher</span> <span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  router<span class="token punctuation">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Matcher <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºè·¯ç”±æ˜ å°„è¡¨</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
    
  <span class="token keyword">function</span> <span class="token function">addRoutes</span> <span class="token punctuation">(</span><span class="token parameter">routes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è·¯ç”±åŒ¹é…</span>
  <span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
    <span class="token parameter">raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
    currentRoute<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    match<span class="token punctuation">,</span>
    addRoutes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createMatcher</code> å‡½æ•°çš„ä½œç”¨å°±æ˜¯åˆ›å»ºè·¯ç”±æ˜ å°„è¡¨ï¼Œç„¶åé€šè¿‡é—­åŒ…çš„æ–¹å¼è®© <code>addRoutes</code> å’Œ <code>match</code> å‡½æ•°èƒ½å¤Ÿä½¿ç”¨è·¯ç”±æ˜ å°„è¡¨çš„å‡ ä¸ªå¯¹è±¡ï¼Œæœ€åè¿”å›ä¸€ä¸ª <code>Matcher</code> å¯¹è±¡ã€‚</p> <p>æ¥ä¸‹æ¥çœ‹ <code>createMatcher</code> å‡½æ•°æ—¶å¦‚ä½•åˆ›å»ºæ˜ å°„è¡¨çš„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteMap</span> <span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathList<span class="token operator">?</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathMap<span class="token operator">?</span><span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldNameMap<span class="token operator">?</span><span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºæ˜ å°„è¡¨</span>
  <span class="token keyword">const</span> pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldNameMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// éå†è·¯ç”±é…ç½®ï¼Œä¸ºæ¯ä¸ªé…ç½®æ·»åŠ è·¯ç”±è®°å½•</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// ç¡®ä¿é€šé…ç¬¦åœ¨æœ€å</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      l<span class="token operator">--</span>
      i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">,</span>
    pathMap<span class="token punctuation">,</span>
    nameMap
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ·»åŠ è·¯ç”±è®°å½•</span>
<span class="token keyword">function</span> <span class="token function">addRouteRecord</span> <span class="token punctuation">(</span>
  <span class="token parameter">pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  route<span class="token punctuation">:</span> RouteConfig<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
  matchAs<span class="token operator">?</span><span class="token punctuation">:</span> string</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å¾—è·¯ç”±é…ç½®ä¸‹çš„å±æ€§</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> route
  <span class="token keyword">const</span> pathToRegexpOptions<span class="token punctuation">:</span> PathToRegexpOptions <span class="token operator">=</span> route<span class="token punctuation">.</span>pathToRegexpOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// æ ¼å¼åŒ– urlï¼Œæ›¿æ¢ / </span>
  <span class="token keyword">const</span> normalizedPath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>
    path<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    pathToRegexpOptions<span class="token punctuation">.</span>strict
  <span class="token punctuation">)</span>
  <span class="token comment">// ç”Ÿæˆè®°å½•å¯¹è±¡</span>
  <span class="token keyword">const</span> record<span class="token punctuation">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> normalizedPath<span class="token punctuation">,</span>
    regex<span class="token punctuation">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    matchAs<span class="token punctuation">,</span>
    redirect<span class="token punctuation">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    beforeEnter<span class="token punctuation">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span> route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">:</span> route<span class="token punctuation">.</span>components
        <span class="token operator">?</span> route<span class="token punctuation">.</span>props
        <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€’å½’è·¯ç”±é…ç½®çš„ children å±æ€§ï¼Œæ·»åŠ è·¯ç”±è®°å½•</span>
    route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs
        <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">undefined</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœè·¯ç”±æœ‰åˆ«åçš„è¯</span>
  <span class="token comment">// ç»™åˆ«åä¹Ÿæ·»åŠ è·¯ç”±è®°å½•</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">)</span>
      <span class="token operator">?</span> route<span class="token punctuation">.</span>alias
      <span class="token punctuation">:</span> <span class="token punctuation">[</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">]</span>

    aliases<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">alias</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> aliasRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> alias<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> route<span class="token punctuation">.</span>children
      <span class="token punctuation">}</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
        pathList<span class="token punctuation">,</span>
        pathMap<span class="token punctuation">,</span>
        nameMap<span class="token punctuation">,</span>
        aliasRoute<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        record<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span> <span class="token comment">// matchAs</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ›´æ–°æ˜ å°„è¡¨</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> record
  <span class="token punctuation">}</span>
  <span class="token comment">// å‘½åè·¯ç”±æ·»åŠ è®°å½•</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> record
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate named routes definition: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; }</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šå°±æ˜¯åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡çš„å…¨è¿‡ç¨‹ï¼Œé€šè¿‡ç”¨æˆ·é…ç½®çš„è·¯ç”±è§„åˆ™æ¥åˆ›å»ºå¯¹åº”çš„è·¯ç”±æ˜ å°„è¡¨ã€‚</p> <h2 id="è·¯ç”±åˆå§‹åŒ–"><a href="#è·¯ç”±åˆå§‹åŒ–" aria-hidden="true" class="header-anchor">#</a> è·¯ç”±åˆå§‹åŒ–</h2> <p>å½“æ ¹ç»„ä»¶è°ƒç”¨ <code>beforeCreate</code> é’©å­å‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// åªæœ‰æ ¹ç»„ä»¶æœ‰ router å±æ€§ï¼Œæ‰€ä»¥æ ¹ç»„ä»¶åˆå§‹åŒ–æ—¶ä¼šåˆå§‹åŒ–è·¯ç”±</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
  <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹ä¸‹è·¯ç”±åˆå§‹åŒ–ä¼šåšäº›ä»€ä¹ˆ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">init</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¿å­˜ç»„ä»¶å®ä¾‹</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token comment">// å¦‚æœæ ¹ç»„ä»¶å·²ç»æœ‰äº†å°±è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app
    <span class="token comment">// èµ‹å€¼è·¯ç”±æ¨¡å¼</span>
    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history
    <span class="token comment">// åˆ¤æ–­è·¯ç”±æ¨¡å¼ï¼Œä»¥å“ˆå¸Œæ¨¡å¼ä¸ºä¾‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ·»åŠ  hashchange ç›‘å¬</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è·¯ç”±è·³è½¬</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupHashListener<span class="token punctuation">,</span>
        setupHashListener
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¯¥å›è°ƒä¼šåœ¨ transitionTo ä¸­è°ƒç”¨</span>
    <span class="token comment">// å¯¹ç»„ä»¶çš„ _route å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œè§¦å‘ç»„ä»¶æ¸²æŸ“</span>
    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>åœ¨è·¯ç”±åˆå§‹åŒ–æ—¶ï¼Œæ ¸å¿ƒå°±æ˜¯è¿›è¡Œè·¯ç”±çš„è·³è½¬ï¼Œæ”¹å˜ URL ç„¶åæ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ã€‚æ¥ä¸‹æ¥æ¥çœ‹ä¸€ä¸‹è·¯ç”±æ˜¯å¦‚ä½•è¿›è¡Œè·³è½¬çš„ã€‚</p> <h2 id="è·¯ç”±è·³è½¬"><a href="#è·¯ç”±è·³è½¬" aria-hidden="true" class="header-anchor">#</a> è·¯ç”±è·³è½¬</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–åŒ¹é…çš„è·¯ç”±ä¿¡æ¯</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token comment">// ç¡®è®¤åˆ‡æ¢è·¯ç”±</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»¥ä¸‹ä¸ºåˆ‡æ¢è·¯ç”±æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒ</span>
    <span class="token comment">// æ›´æ–°è·¯ç”±ä¿¡æ¯ï¼Œå¯¹ç»„ä»¶çš„ _route å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œè§¦å‘ç»„ä»¶æ¸²æŸ“</span>
    <span class="token comment">// è°ƒç”¨ afterHooks ä¸­çš„é’©å­å‡½æ•°</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token comment">// æ·»åŠ  hashchange ç›‘å¬</span>
    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token comment">// æ›´æ–° URL</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// åªæ‰§è¡Œä¸€æ¬¡ ready å›è°ƒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// é”™è¯¯å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨è·¯ç”±è·³è½¬ä¸­ï¼Œéœ€è¦å…ˆè·å–åŒ¹é…çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥å…ˆæ¥çœ‹ä¸‹å¦‚ä½•è·å–åŒ¹é…çš„è·¯ç”±ä¿¡æ¯</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
  <span class="token parameter">raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
  currentRoute<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token comment">// åºåˆ—åŒ– url</span>
  <span class="token comment">// æ¯”å¦‚å¯¹äºè¯¥ url æ¥è¯´ /abc?foo=bar&amp;baz=qux#hello</span>
  <span class="token comment">// ä¼šåºåˆ—åŒ–è·¯å¾„ä¸º /abc</span>
  <span class="token comment">// å“ˆå¸Œä¸º #hello</span>
  <span class="token comment">// å‚æ•°ä¸º foo: 'bar', baz: 'qux'</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> currentRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> location
  <span class="token comment">// å¦‚æœæ˜¯å‘½åè·¯ç”±ï¼Œå°±åˆ¤æ–­è®°å½•ä¸­æ˜¯å¦æœ‰è¯¥å‘½åè·¯ç”±é…ç½®</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token comment">// æ²¡æ‰¾åˆ°è¡¨ç¤ºæ²¡æœ‰åŒ¹é…çš„è·¯ç”±</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
    <span class="token keyword">const</span> paramNames <span class="token operator">=</span> record<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>keys
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span>optional<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token comment">// å‚æ•°å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> location<span class="token punctuation">.</span>params <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoute <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> currentRoute<span class="token punctuation">.</span>params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éå‘½åè·¯ç”±å¤„ç†</span>
    location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// æŸ¥æ‰¾è®°å½•</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> pathMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
      <span class="token comment">// å¦‚æœåŒ¹é…è·¯ç”±ï¼Œåˆ™åˆ›å»ºè·¯ç”±</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> location<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ²¡æœ‰åŒ¹é…çš„è·¯ç”±</span>
  <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºè·¯ç”±</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ ¹æ®æ¡ä»¶åˆ›å»ºä¸åŒçš„è·¯ç”±</span>
<span class="token keyword">function</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">alias</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoute</span> <span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Location<span class="token punctuation">,</span>
  router<span class="token operator">?</span><span class="token punctuation">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringifyQuery <span class="token operator">=</span> router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>stringifyQuery
  <span class="token comment">// å…‹éš†å‚æ•°</span>
  <span class="token keyword">let</span> query<span class="token punctuation">:</span> any <span class="token operator">=</span> location<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    query <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºè·¯ç”±å¯¹è±¡</span>
  <span class="token keyword">const</span> route<span class="token punctuation">:</span> Route <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> location<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> location<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    hash<span class="token punctuation">:</span> location<span class="token punctuation">.</span>hash <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> location<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    fullPath<span class="token punctuation">:</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span><span class="token punctuation">,</span>
    matched<span class="token punctuation">:</span> record <span class="token operator">?</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è®©è·¯ç”±å¯¹è±¡ä¸å¯ä¿®æ”¹</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// è·å¾—åŒ…å«å½“å‰è·¯ç”±çš„æ‰€æœ‰åµŒå¥—è·¯å¾„ç‰‡æ®µçš„è·¯ç”±è®°å½•</span>
<span class="token comment">// åŒ…å«ä»æ ¹è·¯ç”±åˆ°å½“å‰è·¯ç”±çš„åŒ¹é…è®°å½•ï¼Œä»ä¸Šè‡³ä¸‹</span>
<span class="token keyword">function</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>
    record <span class="token operator">=</span> record<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p>è‡³æ­¤åŒ¹é…è·¯ç”±å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å›åˆ° <code>transitionTo</code> å‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ <code>confirmTransition</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç¡®è®¤åˆ‡æ¢è·¯ç”±</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">confirmTransition</span><span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token comment">// ä¸­æ–­è·³è½¬è·¯ç”±å‡½æ•°</span>
  <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœæ˜¯ç›¸åŒçš„è·¯ç”±å°±ä¸è·³è½¬</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// é€šè¿‡å¯¹æ¯”è·¯ç”±è§£æå‡ºå¯å¤ç”¨çš„ç»„ä»¶ï¼Œéœ€è¦æ¸²æŸ“çš„ç»„ä»¶ï¼Œå¤±æ´»çš„ç»„ä»¶</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
    route<span class="token punctuation">.</span>matched
  <span class="token punctuation">)</span>
  
  <span class="token keyword">function</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
      <span class="token parameter">current<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      next<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      updated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      activated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      deactivated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> i
      <span class="token keyword">const</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>length<span class="token punctuation">,</span> next<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“å‰è·¯ç”±è·¯å¾„å’Œè·³è½¬è·¯ç”±è·¯å¾„ä¸åŒæ—¶è·³å‡ºéå†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯å¤ç”¨çš„ç»„ä»¶å¯¹åº”è·¯ç”±</span>
        updated<span class="token punctuation">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// éœ€è¦æ¸²æŸ“çš„ç»„ä»¶å¯¹åº”è·¯ç”±</span>
        activated<span class="token punctuation">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// å¤±æ´»çš„ç»„ä»¶å¯¹åº”è·¯ç”±</span>
        deactivated<span class="token punctuation">:</span> current<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¯¼èˆªå®ˆå«æ•°ç»„</span>
  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
    <span class="token comment">// å¤±æ´»çš„ç»„ä»¶é’©å­</span>
    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// å…¨å±€ beforeEach é’©å­</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
    <span class="token comment">// åœ¨å½“å‰è·¯ç”±æ”¹å˜ï¼Œä½†æ˜¯è¯¥ç»„ä»¶è¢«å¤ç”¨æ—¶è°ƒç”¨</span>
    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// éœ€è¦æ¸²æŸ“ç»„ä»¶ enter å®ˆå«é’©å­</span>
    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶</span>
    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// ä¿å­˜è·¯ç”±</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route
  <span class="token comment">// è¿­ä»£å™¨ï¼Œç”¨äºæ‰§è¡Œ queue ä¸­çš„å¯¼èˆªå®ˆå«é’©å­</span>
  <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·¯ç”±ä¸ç›¸ç­‰å°±ä¸è·³è½¬è·¯ç”±</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œé’©å­</span>
      <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// åªæœ‰æ‰§è¡Œäº†é’©å­å‡½æ•°ä¸­çš„ nextï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªé’©å­å‡½æ•°</span>
        <span class="token comment">// å¦åˆ™ä¼šæš‚åœè·³è½¬</span>
        <span class="token comment">// ä»¥ä¸‹é€»è¾‘æ˜¯åœ¨åˆ¤æ–­ next() ä¸­çš„ä¼ å‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next(false) </span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// next('/') æˆ–è€… next({ path: '/' }) -&gt; é‡å®šå‘</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿™é‡Œæ‰§è¡Œ next</span>
        <span class="token comment">// ä¹Ÿå°±æ˜¯æ‰§è¡Œä¸‹é¢å‡½æ•° runQueue ä¸­çš„ step(index + 1)</span>
          <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç»å…¸çš„åŒæ­¥æ‰§è¡Œå¼‚æ­¥å‡½æ•°</span>
  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
    <span class="token comment">// å½“æ‰€æœ‰å¼‚æ­¥ç»„ä»¶åŠ è½½å®Œæˆåï¼Œä¼šæ‰§è¡Œè¿™é‡Œçš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯ runQueue ä¸­çš„ cb()</span>
    <span class="token comment">// æ¥ä¸‹æ¥æ‰§è¡Œ éœ€è¦æ¸²æŸ“ç»„ä»¶çš„å¯¼èˆªå®ˆå«é’©å­</span>
    <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·³è½¬å®Œæˆ</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runQueue</span> <span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// é˜Ÿåˆ—ä¸­çš„å‡½æ•°éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå°±æ‰§è¡Œå›è°ƒå‡½æ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ‰§è¡Œè¿­ä»£å™¨ï¼Œç”¨æˆ·åœ¨é’©å­å‡½æ•°ä¸­æ‰§è¡Œ next() å›è°ƒ</span>
      <span class="token comment">// å›è°ƒä¸­åˆ¤æ–­ä¼ å‚ï¼Œæ²¡æœ‰é—®é¢˜å°±æ‰§è¡Œ next()ï¼Œä¹Ÿå°±æ˜¯ fn å‡½æ•°ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å–å‡ºé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªé’©å­å‡½æ•°</span>
  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥ä»‹ç»å¯¼èˆªå®ˆå«</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
    <span class="token comment">// å¤±æ´»çš„ç»„ä»¶é’©å­</span>
    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// å…¨å±€ beforeEach é’©å­</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
    <span class="token comment">// åœ¨å½“å‰è·¯ç”±æ”¹å˜ï¼Œä½†æ˜¯è¯¥ç»„ä»¶è¢«å¤ç”¨æ—¶è°ƒç”¨</span>
    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// éœ€è¦æ¸²æŸ“ç»„ä»¶ enter å®ˆå«é’©å­</span>
    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶</span>
    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>ç¬¬ä¸€æ­¥æ˜¯å…ˆæ‰§è¡Œå¤±æ´»ç»„ä»¶çš„é’©å­å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span><span class="token parameter">deactivated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// ä¼ å…¥éœ€è¦æ‰§è¡Œçš„é’©å­å‡½æ•°å</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">,</span> <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>
  <span class="token parameter">records<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  bind<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  reverse<span class="token operator">?</span><span class="token punctuation">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">def<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ‰¾å‡ºç»„ä»¶ä¸­å¯¹åº”çš„é’©å­å‡½æ•°</span>
    <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç»™æ¯ä¸ªé’©å­å‡½æ•°æ·»åŠ ä¸Šä¸‹æ–‡å¯¹è±¡ä¸ºç»„ä»¶è‡ªèº«</span>
      <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>
        <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">guard</span> <span class="token operator">=&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// æ•°ç»„é™ç»´ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦ç¿»è½¬æ•°ç»„</span>
  <span class="token comment">// å› ä¸ºæŸäº›é’©å­å‡½æ•°éœ€è¦ä»å­æ‰§è¡Œåˆ°çˆ¶</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>reverse <span class="token operator">?</span> guards<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flatMapComponents</span> <span class="token punctuation">(</span>
  <span class="token parameter">matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  fn<span class="token punctuation">:</span> Function</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// æ•°ç»„é™ç»´</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// å°†ç»„ä»¶ä¸­çš„å¯¹è±¡ä¼ å…¥å›è°ƒå‡½æ•°ä¸­ï¼Œè·å¾—é’©å­å‡½æ•°æ•°ç»„</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>
      m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
      m<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
      m<span class="token punctuation">,</span> key
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç¬¬äºŒæ­¥æ‰§è¡Œå…¨å±€ beforeEach é’©å­å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeEach</span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ VueRouter ç±»ä¸­æœ‰ä»¥ä¸Šä»£ç ï¼Œæ¯å½“ç»™ VueRouter å®ä¾‹æ·»åŠ  beforeEach å‡½æ•°æ—¶å°±ä¼šå°†å‡½æ•° push è¿› beforeHooks ä¸­ã€‚</p> <p>ç¬¬ä¸‰æ­¥æ‰§è¡Œ <code>beforeRouteUpdate</code> é’©å­å‡½æ•°ï¼Œè°ƒç”¨æ–¹å¼å’Œç¬¬ä¸€æ­¥ç›¸åŒï¼Œåªæ˜¯ä¼ å…¥çš„å‡½æ•°åä¸åŒï¼Œåœ¨è¯¥å‡½æ•°ä¸­å¯ä»¥è®¿é—®åˆ° <code>this</code> å¯¹è±¡ã€‚</p> <p>ç¬¬å››æ­¥æ‰§è¡Œ <code>beforeEnter</code> é’©å­å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯è·¯ç”±ç‹¬äº«çš„é’©å­å‡½æ•°ã€‚</p> <p>ç¬¬äº”æ­¥æ˜¯è§£æå¼‚æ­¥ç»„ä»¶ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsyncComponents</span> <span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hasAsync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// è¯¥å‡½æ•°ä½œç”¨ä¹‹å‰å·²ç»ä»‹ç»è¿‡äº†</span>
    <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>matched<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">def<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥ç»„ä»¶</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> def<span class="token punctuation">.</span>cid <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasAsync <span class="token operator">=</span> <span class="token boolean">true</span>
        pending<span class="token operator">++</span>
        <span class="token comment">// æˆåŠŸå›è°ƒ</span>
        <span class="token comment">// once å‡½æ•°ç¡®ä¿å¼‚æ­¥ç»„ä»¶åªåŠ è½½ä¸€æ¬¡</span>
        <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">resolvedDef</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isESModule</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolvedDef <span class="token operator">=</span> resolvedDef<span class="token punctuation">.</span>default
          <span class="token punctuation">}</span>
          <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æ„é€ å‡½æ•°</span>
          <span class="token comment">// ä¸æ˜¯çš„è¯é€šè¿‡ Vue æ¥ç”Ÿæˆç»„ä»¶æ„é€ å‡½æ•°</span>
          def<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token keyword">typeof</span> resolvedDef <span class="token operator">===</span> <span class="token string">'function'</span>
            <span class="token operator">?</span> resolvedDef
            <span class="token punctuation">:</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span>
        <span class="token comment">// èµ‹å€¼ç»„ä»¶</span>
        <span class="token comment">// å¦‚æœç»„ä»¶å…¨éƒ¨è§£æå®Œæ¯•ï¼Œç»§ç»­ä¸‹ä¸€æ­¥</span>
          match<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedDef
          pending<span class="token operator">--</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// å¤±è´¥å›è°ƒ</span>
        <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve async component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token function">isError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
              <span class="token operator">?</span> reason
              <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> res
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰§è¡Œå¼‚æ­¥ç»„ä»¶å‡½æ•°</span>
          res <span class="token operator">=</span> <span class="token function">def</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸‹è½½å®Œæˆæ‰§è¡Œå›è°ƒ</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> comp <span class="token operator">=</span> res<span class="token punctuation">.</span>component
            <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> comp<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              comp<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// ä¸æ˜¯å¼‚æ­¥ç»„ä»¶ç›´æ¥ä¸‹ä¸€æ­¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAsync<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šå°±æ˜¯ç¬¬ä¸€ä¸ª <code>runQueue</code> ä¸­çš„é€»è¾‘ï¼Œç¬¬äº”æ­¥å®Œæˆåä¼šæ‰§è¡Œç¬¬ä¸€ä¸ª <code>runQueue</code> ä¸­å›è°ƒå‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è¯¥å›è°ƒç”¨äºä¿å­˜ `beforeRouteEnter` é’©å­ä¸­çš„å›è°ƒå‡½æ•°</span>
<span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
<span class="token comment">// beforeRouteEnter å¯¼èˆªå®ˆå«é’©å­</span>
<span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
<span class="token comment">// beforeResolve å¯¼èˆªå®ˆå«é’©å­</span>
<span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
<span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// è¿™é‡Œä¼šæ‰§è¡Œ afterEach å¯¼èˆªå®ˆå«é’©å­</span>
  <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ç¬¬å…­æ­¥æ˜¯æ‰§è¡Œ <code>beforeRouteEnter</code> å¯¼èˆªå®ˆå«é’©å­ï¼Œ<code>beforeRouteEnter</code> é’©å­ä¸èƒ½è®¿é—® <code>this</code> å¯¹è±¡ï¼Œå› ä¸ºé’©å­åœ¨å¯¼èˆªç¡®è®¤å‰è¢«è°ƒç”¨ï¼Œéœ€è¦æ¸²æŸ“çš„ç»„ä»¶è¿˜æ²¡è¢«åˆ›å»ºã€‚ä½†æ˜¯è¯¥é’©å­å‡½æ•°æ˜¯å”¯ä¸€ä¸€ä¸ªæ”¯æŒåœ¨å›è°ƒä¸­è·å– <code>this</code> å¯¹è±¡çš„å‡½æ•°ï¼Œå›è°ƒä¼šåœ¨è·¯ç”±ç¡®è®¤æ‰§è¡Œã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeRouteEnter</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">vm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡ `vm` è®¿é—®ç»„ä»¶å®ä¾‹</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸‹é¢æ¥çœ‹çœ‹æ˜¯å¦‚ä½•æ”¯æŒåœ¨å›è°ƒä¸­æ‹¿åˆ° <code>this</code> å¯¹è±¡çš„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>
  activated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// è¿™é‡Œå’Œä¹‹å‰è°ƒç”¨å¯¼èˆªå®ˆå«åŸºæœ¬ä¸€è‡´</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>
    activated<span class="token punctuation">,</span>
    <span class="token string">'beforeRouteEnter'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">guard<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">bindEnterGuard</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">bindEnterGuard</span><span class="token punctuation">(</span>
  guard<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span>
  match<span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  cbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token punctuation">:</span> NavigationGuard <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">routeEnterGuard</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­ cb æ˜¯å¦æ˜¯å‡½æ•°</span>
    <span class="token comment">// æ˜¯çš„è¯å°± push è¿› postEnterCbs</span>
      <span class="token function">next</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> cb <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¾ªç¯ç›´åˆ°æ‹¿åˆ°ç»„ä»¶å®ä¾‹</span>
          <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> match<span class="token punctuation">.</span>instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¯¥å‡½æ•°æ˜¯ä¸ºäº†è§£å†³ issus #750</span>
<span class="token comment">// å½“ router-view å¤–é¢åŒ…è£¹äº† mode ä¸º out-in çš„ transition ç»„ä»¶ </span>
<span class="token comment">// ä¼šåœ¨ç»„ä»¶åˆæ¬¡å¯¼èˆªåˆ°æ—¶è·å¾—ä¸åˆ°ç»„ä»¶å®ä¾‹å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">poll</span><span class="token punctuation">(</span>
  cb<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token comment">// somehow flow cannot infer this is a function</span>
  instances<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>_isBeingDestroyed <span class="token comment">// do not reuse being destroyed instance</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// setTimeout 16ms ä½œç”¨å’Œ nextTick åŸºæœ¬ç›¸åŒ</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç¬¬ä¸ƒæ­¥æ˜¯æ‰§è¡Œ <code>beforeResolve</code> å¯¼èˆªå®ˆå«é’©å­ï¼Œå¦‚æœæ³¨å†Œäº†å…¨å±€ <code>beforeResolve</code> é’©å­å°±ä¼šåœ¨è¿™é‡Œæ‰§è¡Œã€‚</p> <p>ç¬¬å…«æ­¥å°±æ˜¯å¯¼èˆªç¡®è®¤ï¼Œè°ƒç”¨ <code>afterEach</code> å¯¼èˆªå®ˆå«é’©å­äº†ã€‚</p> <p>ä»¥ä¸Šéƒ½æ‰§è¡Œå®Œæˆåï¼Œä¼šè§¦å‘ç»„ä»¶çš„æ¸²æŸ“</p> <div class="language-js extra-class"><pre class="language-js"><code>history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ä»¥ä¸Šå›è°ƒä¼šåœ¨ <code>updateRoute</code> ä¸­è°ƒç”¨</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">updateRoute</span><span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">:</span> Route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‡³æ­¤ï¼Œè·¯ç”±è·³è½¬å·²ç»å…¨éƒ¨åˆ†æå®Œæ¯•ã€‚æ ¸å¿ƒå°±æ˜¯åˆ¤æ–­éœ€è¦è·³è½¬çš„è·¯ç”±æ˜¯å¦å­˜åœ¨äºè®°å½•ä¸­ï¼Œç„¶åæ‰§è¡Œå„ç§å¯¼èˆªå®ˆå«å‡½æ•°ï¼Œæœ€åå®Œæˆ URL çš„æ”¹å˜å’Œç»„ä»¶çš„æ¸²æŸ“ã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.33c008d4.js" defer></script><script src="/assets/js/2.f6583267.js" defer></script><script src="/assets/js/15.5f8fabb6.js" defer></script>
  </body>
</html>
