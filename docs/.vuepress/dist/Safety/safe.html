<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ</title>
    <meta name="description" content="å‰ç«¯åšå®¢ä¹‹å®¶">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.1b45e88d.css" as="style"><link rel="preload" href="/assets/js/app.33c008d4.js" as="script"><link rel="preload" href="/assets/js/2.f6583267.js" as="script"><link rel="preload" href="/assets/js/14.1f821c0e.js" as="script"><link rel="prefetch" href="/assets/js/10.029a3a95.js"><link rel="prefetch" href="/assets/js/11.c254ac84.js"><link rel="prefetch" href="/assets/js/12.b90513f5.js"><link rel="prefetch" href="/assets/js/13.31b150fc.js"><link rel="prefetch" href="/assets/js/15.5f8fabb6.js"><link rel="prefetch" href="/assets/js/16.4e49ae2a.js"><link rel="prefetch" href="/assets/js/17.1c855a6b.js"><link rel="prefetch" href="/assets/js/18.a10f2c1b.js"><link rel="prefetch" href="/assets/js/19.196ac4bb.js"><link rel="prefetch" href="/assets/js/20.8281acf4.js"><link rel="prefetch" href="/assets/js/3.4ec713e1.js"><link rel="prefetch" href="/assets/js/4.b6f69170.js"><link rel="prefetch" href="/assets/js/5.2c36c48a.js"><link rel="prefetch" href="/assets/js/6.d20ed2a3.js"><link rel="prefetch" href="/assets/js/7.7ef12aec.js"><link rel="prefetch" href="/assets/js/8.e106a615.js"><link rel="prefetch" href="/assets/js/9.aa586946.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b45e88d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://q285gdauq.bkt.clouddn.com/sunligjt.jpg" alt="å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ" class="logo"> <span class="site-name can-hide">å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/JS/" class="nav-link">JSåŸºç¡€</a></div><div class="nav-item"><a href="/Vue/vue.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/React/" class="nav-link">ReactåŠè§£</a></div><div class="nav-item"><a href="/Network/" class="nav-link">è®¡ç®—æœºç½‘ç»œ</a></div><div class="nav-item"><a href="/Browser/browser.html" class="nav-link">æµè§ˆå™¨</a></div><div class="nav-item"><a href="/Safety/safe.html" class="nav-link router-link-exact-active router-link-active">ç½‘ç»œå®‰å…¨</a></div><div class="nav-item"><a href="/Performance/performance.html" class="nav-link">æ€§èƒ½ä¼˜åŒ–ç‚¹</a></div><div class="nav-item"><a href="/Datastruct/datastruct.html" class="nav-link">æ•°æ®ç»“æ„</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">ç®—æ³•</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/JS/" class="nav-link">JSåŸºç¡€</a></div><div class="nav-item"><a href="/Vue/vue.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/React/" class="nav-link">ReactåŠè§£</a></div><div class="nav-item"><a href="/Network/" class="nav-link">è®¡ç®—æœºç½‘ç»œ</a></div><div class="nav-item"><a href="/Browser/browser.html" class="nav-link">æµè§ˆå™¨</a></div><div class="nav-item"><a href="/Safety/safe.html" class="nav-link router-link-exact-active router-link-active">ç½‘ç»œå®‰å…¨</a></div><div class="nav-item"><a href="/Performance/performance.html" class="nav-link">æ€§èƒ½ä¼˜åŒ–ç‚¹</a></div><div class="nav-item"><a href="/Datastruct/datastruct.html" class="nav-link">æ•°æ®ç»“æ„</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">ç®—æ³•</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Safety/safe.html#è„æ•°æ®æ£€æµ‹" class="sidebar-link">è„æ•°æ®æ£€æµ‹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Safety/safe.html#æ•°æ®åŠ«æŒ" class="sidebar-link">æ•°æ®åŠ«æŒ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Safety/safe.html#proxy-ä¸-object-defineproperty-å¯¹æ¯”" class="sidebar-link">Proxy ä¸ Object.defineProperty å¯¹æ¯”</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Safety/safe.html#ä¸ºä»€ä¹ˆéœ€è¦-virtual-dom" class="sidebar-link">ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Safety/safe.html#virtual-dom-ç®—æ³•ç®€è¿°" class="sidebar-link">Virtual Dom ç®—æ³•ç®€è¿°</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Safety/safe.html#virtual-dom-ç®—æ³•å®ç°" class="sidebar-link">Virtual Dom ç®—æ³•å®ç°</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Safety/safe.html#æ ‘çš„é€’å½’" class="sidebar-link">æ ‘çš„é€’å½’</a></li><li class="sidebar-sub-header"><a href="/Safety/safe.html#åˆ¤æ–­å±æ€§çš„æ›´æ”¹" class="sidebar-link">åˆ¤æ–­å±æ€§çš„æ›´æ”¹</a></li><li class="sidebar-sub-header"><a href="/Safety/safe.html#åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°" class="sidebar-link">åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</a></li><li class="sidebar-sub-header"><a href="/Safety/safe.html#éå†å­å…ƒç´ æ‰“æ ‡è¯†" class="sidebar-link">éå†å­å…ƒç´ æ‰“æ ‡è¯†</a></li><li class="sidebar-sub-header"><a href="/Safety/safe.html#æ¸²æŸ“å·®å¼‚" class="sidebar-link">æ¸²æŸ“å·®å¼‚</a></li></ul></li><li><a href="/Safety/safe.html#æœ€å" class="sidebar-link">æœ€å</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <ul><li><a href="#mvvm">MVVM</a> <ul><li><a href="#%E8%84%8F%E6%95%B0%E6%8D%AE%E6%A3%80%E6%B5%8B">è„æ•°æ®æ£€æµ‹</a></li> <li><a href="#%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81">æ•°æ®åŠ«æŒ</a></li> <li><a href="#proxy-%E4%B8%8E-objectdefineproperty-%E5%AF%B9%E6%AF%94">Proxy ä¸ Object.defineProperty å¯¹æ¯”</a></li></ul></li> <li><a href="#%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86">è·¯ç”±åŸç†</a></li> <li><a href="#virtual-dom">Virtual Dom</a> <ul><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-virtual-dom">ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</a></li> <li><a href="#virtual-dom-%E7%AE%97%E6%B3%95%E7%AE%80%E8%BF%B0">Virtual Dom ç®—æ³•ç®€è¿°</a></li> <li><a href="#virtual-dom-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">Virtual Dom ç®—æ³•å®ç°</a> <ul><li><a href="#%E6%A0%91%E7%9A%84%E9%80%92%E5%BD%92">æ ‘çš„é€’å½’</a></li> <li><a href="#%E5%88%A4%E6%96%AD%E5%B1%9E%E6%80%A7%E7%9A%84%E6%9B%B4%E6%94%B9">åˆ¤æ–­å±æ€§çš„æ›´æ”¹</a></li> <li><a href="#%E5%88%A4%E6%96%AD%E5%88%97%E8%A1%A8%E5%B7%AE%E5%BC%82%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</a></li> <li><a href="#%E9%81%8D%E5%8E%86%E5%AD%90%E5%85%83%E7%B4%A0%E6%89%93%E6%A0%87%E8%AF%86">éå†å­å…ƒç´ æ‰“æ ‡è¯†</a></li> <li><a href="#%E6%B8%B2%E6%9F%93%E5%B7%AE%E5%BC%82">æ¸²æŸ“å·®å¼‚</a></li></ul></li> <li><a href="#%E6%9C%80%E5%90%8E">æœ€å</a></li></ul></li></ul> <h1 id="mvvm"><a href="#mvvm" aria-hidden="true" class="header-anchor">#</a> MVVM</h1> <p>MVVM ç”±ä»¥ä¸‹ä¸‰ä¸ªå†…å®¹ç»„æˆ</p> <ul><li>Viewï¼šç•Œé¢</li> <li>Modelï¼šæ•°æ®æ¨¡å‹</li> <li>ViewModelï¼šä½œä¸ºæ¡¥æ¢è´Ÿè´£æ²Ÿé€š View å’Œ Model</li></ul> <p>åœ¨ JQuery æ—¶æœŸï¼Œå¦‚æœéœ€è¦åˆ·æ–° UI æ—¶ï¼Œéœ€è¦å…ˆå–åˆ°å¯¹åº”çš„ DOM å†æ›´æ–° UIï¼Œè¿™æ ·æ•°æ®å’Œä¸šåŠ¡çš„é€»è¾‘å°±å’Œé¡µé¢æœ‰å¼ºè€¦åˆã€‚</p> <p>åœ¨ MVVM ä¸­ï¼ŒUI æ˜¯é€šè¿‡æ•°æ®é©±åŠ¨çš„ï¼Œæ•°æ®ä¸€æ—¦æ”¹å˜å°±ä¼šç›¸åº”çš„åˆ·æ–°å¯¹åº”çš„ UIï¼ŒUI å¦‚æœæ”¹å˜ï¼Œä¹Ÿä¼šæ”¹å˜å¯¹åº”çš„æ•°æ®ã€‚è¿™ç§æ–¹å¼å°±å¯ä»¥åœ¨ä¸šåŠ¡å¤„ç†ä¸­åªå…³å¿ƒæ•°æ®çš„æµè½¬ï¼Œè€Œæ— éœ€ç›´æ¥å’Œé¡µé¢æ‰“äº¤é“ã€‚ViewModel åªå…³å¿ƒæ•°æ®å’Œä¸šåŠ¡çš„å¤„ç†ï¼Œä¸å…³å¿ƒ View å¦‚ä½•å¤„ç†æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒView å’Œ Model éƒ½å¯ä»¥ç‹¬ç«‹å‡ºæ¥ï¼Œä»»ä½•ä¸€æ–¹æ”¹å˜äº†ä¹Ÿä¸ä¸€å®šéœ€è¦æ”¹å˜å¦ä¸€æ–¹ï¼Œå¹¶ä¸”å¯ä»¥å°†ä¸€äº›å¯å¤ç”¨çš„é€»è¾‘æ”¾åœ¨ä¸€ä¸ª ViewModel ä¸­ï¼Œè®©å¤šä¸ª View å¤ç”¨è¿™ä¸ª ViewModelã€‚</p> <p>åœ¨ MVVM ä¸­ï¼Œæœ€æ ¸å¿ƒçš„ä¹Ÿå°±æ˜¯æ•°æ®åŒå‘ç»‘å®šï¼Œä¾‹å¦‚ Angluar çš„è„æ•°æ®æ£€æµ‹ï¼ŒVue ä¸­çš„æ•°æ®åŠ«æŒã€‚</p> <h2 id="è„æ•°æ®æ£€æµ‹"><a href="#è„æ•°æ®æ£€æµ‹" aria-hidden="true" class="header-anchor">#</a> è„æ•°æ®æ£€æµ‹</h2> <p>å½“è§¦å‘äº†æŒ‡å®šäº‹ä»¶åä¼šè¿›å…¥è„æ•°æ®æ£€æµ‹ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ <code>$digest</code> å¾ªç¯éå†æ‰€æœ‰çš„æ•°æ®è§‚å¯Ÿè€…ï¼Œåˆ¤æ–­å½“å‰å€¼æ˜¯å¦å’Œå…ˆå‰çš„å€¼æœ‰åŒºåˆ«ï¼Œå¦‚æœæ£€æµ‹åˆ°å˜åŒ–çš„è¯ï¼Œä¼šè°ƒç”¨ <code>$watch</code> å‡½æ•°ï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>$digest</code> å¾ªç¯ç›´åˆ°å‘ç°æ²¡æœ‰å˜åŒ–ã€‚å¾ªç¯è‡³å°‘ä¸ºäºŒæ¬¡ ï¼Œè‡³å¤šä¸ºåæ¬¡ã€‚</p> <p>è„æ•°æ®æ£€æµ‹è™½ç„¶å­˜åœ¨ä½æ•ˆçš„é—®é¢˜ï¼Œä½†æ˜¯ä¸å…³å¿ƒæ•°æ®æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼æ”¹å˜çš„ï¼Œéƒ½å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œä½†æ˜¯è¿™åœ¨ Vue ä¸­çš„åŒå‘ç»‘å®šæ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚å¹¶ä¸”è„æ•°æ®æ£€æµ‹å¯ä»¥å®ç°æ‰¹é‡æ£€æµ‹å‡ºæ›´æ–°çš„å€¼ï¼Œå†å»ç»Ÿä¸€æ›´æ–° UIï¼Œå¤§å¤§å‡å°‘äº†æ“ä½œ DOM çš„æ¬¡æ•°ã€‚æ‰€ä»¥ä½æ•ˆä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œè¿™å°±ä»è€…è§ä»æ™ºè€…è§æ™ºäº†ã€‚</p> <h2 id="æ•°æ®åŠ«æŒ"><a href="#æ•°æ®åŠ«æŒ" aria-hidden="true" class="header-anchor">#</a> æ•°æ®åŠ«æŒ</h2> <p>Vue å†…éƒ¨ä½¿ç”¨äº† <code>Object.defineProperty()</code> æ¥å®ç°åŒå‘ç»‘å®šï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥ç›‘å¬åˆ° <code>set</code> å’Œ <code>get</code> çš„äº‹ä»¶ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'yck'</span> <span class="token punctuation">}</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> data<span class="token punctuation">.</span>name <span class="token comment">// -&gt; get value</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'yyy'</span> <span class="token comment">// -&gt; change value</span>

<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ç±»å‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€’å½’å­å±æ€§</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change value'</span><span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šä»£ç ç®€å•çš„å®ç°äº†å¦‚ä½•ç›‘å¬æ•°æ®çš„ <code>set</code> å’Œ <code>get</code> çš„äº‹ä»¶ï¼Œä½†æ˜¯ä»…ä»…å¦‚æ­¤æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦åœ¨é€‚å½“çš„æ—¶å€™ç»™å±æ€§æ·»åŠ å‘å¸ƒè®¢é˜…</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {{name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div><p>åœ¨è§£æå¦‚ä¸Šæ¨¡æ¿ä»£ç æ—¶ï¼Œé‡åˆ° <code>{{name}}</code> å°±ä¼šç»™å±æ€§ <code>name</code> æ·»åŠ å‘å¸ƒè®¢é˜…ã€‚</p></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// é€šè¿‡ Dep è§£è€¦</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// sub æ˜¯ Watcher å®ä¾‹</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// å…¨å±€å±æ€§ï¼Œé€šè¿‡è¯¥å±æ€§é…ç½® Watcher</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°† Dep.target æŒ‡å‘è‡ªå·±</span>
    <span class="token comment">// ç„¶åè§¦å‘å±æ€§çš„ getter æ·»åŠ ç›‘å¬</span>
    <span class="token comment">// æœ€åå°† Dep.target ç½®ç©º</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å¾—æ–°å€¼</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span>
    <span class="token comment">// è°ƒç”¨ update æ–¹æ³•æ›´æ–° Dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'yck'</span> <span class="token punctuation">}</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment">// æ¨¡æ‹Ÿè§£æåˆ° `{{name}}` è§¦å‘çš„æ“ä½œ</span>
<span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span>
<span class="token comment">// update Dom innerText</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'yyy'</span> 
</code></pre></div><p>æ¥ä¸‹æ¥,å¯¹ <code>defineReactive</code> å‡½æ•°è¿›è¡Œæ”¹é€ </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€’å½’å­å±æ€§</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token keyword">let</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value'</span><span class="token punctuation">)</span>
      <span class="token comment">// å°† Watcher æ·»åŠ åˆ°è®¢é˜…</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dp<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change value'</span><span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
      <span class="token comment">// æ‰§è¡Œ watcher çš„ update æ–¹æ³•</span>
      dp<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„åŒå‘ç»‘å®šï¼Œæ ¸å¿ƒæ€è·¯å°±æ˜¯æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å±æ€§çš„ getter æ¥å®ç°å‘å¸ƒè®¢é˜…çš„æ·»åŠ ã€‚</p> <h2 id="proxy-ä¸-object-defineproperty-å¯¹æ¯”"><a href="#proxy-ä¸-object-defineproperty-å¯¹æ¯”" aria-hidden="true" class="header-anchor">#</a> Proxy ä¸ Object.defineProperty å¯¹æ¯”</h2> <p><code>Object.defineProperty</code> è™½ç„¶å·²ç»èƒ½å¤Ÿå®ç°åŒå‘ç»‘å®šäº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯æœ‰ç¼ºé™·çš„ã€‚</p> <ol><li>åªèƒ½å¯¹å±æ€§è¿›è¡Œæ•°æ®åŠ«æŒï¼Œæ‰€ä»¥éœ€è¦æ·±åº¦éå†æ•´ä¸ªå¯¹è±¡</li> <li>å¯¹äºæ•°ç»„ä¸èƒ½ç›‘å¬åˆ°æ•°æ®çš„å˜åŒ–</li></ol> <p>è™½ç„¶ Vue ä¸­ç¡®å®èƒ½æ£€æµ‹åˆ°æ•°ç»„æ•°æ®çš„å˜åŒ–ï¼Œä½†æ˜¯å…¶å®æ˜¯ä½¿ç”¨äº† hack çš„åŠæ³•ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯æœ‰ç¼ºé™·çš„ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>
<span class="token comment">// hack ä»¥ä¸‹å‡ ä¸ªå‡½æ•°</span>
<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å¾—åŸç”Ÿå‡½æ•°</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨åŸç”Ÿå‡½æ•°</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment">// è§¦å‘æ›´æ–°</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>åè§‚ Proxy å°±æ²¡ä»¥ä¸Šçš„é—®é¢˜ï¼ŒåŸç”Ÿæ”¯æŒç›‘å¬æ•°ç»„å˜åŒ–ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥å¯¹æ•´ä¸ªå¯¹è±¡è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥ Vue ä¹Ÿå°†åœ¨ä¸‹ä¸ªå¤§ç‰ˆæœ¬ä¸­ä½¿ç”¨ Proxy æ›¿æ¢ Object.defineProperty</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">onWatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> setBind<span class="token punctuation">,</span> getLogger</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getLogger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setBind</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> value
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">onWatch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> v
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Get '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>property<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// bind `value` to `2`</span>
p<span class="token punctuation">.</span>a <span class="token comment">// -&gt; Get 'a' = 2</span>
</code></pre></div><h1 id="è·¯ç”±åŸç†"><a href="#è·¯ç”±åŸç†" aria-hidden="true" class="header-anchor">#</a> è·¯ç”±åŸç†</h1> <p>å‰ç«¯è·¯ç”±å®ç°èµ·æ¥å…¶å®å¾ˆç®€å•ï¼Œæœ¬è´¨å°±æ˜¯ç›‘å¬ URL çš„å˜åŒ–ï¼Œç„¶ååŒ¹é…è·¯ç”±è§„åˆ™ï¼Œæ˜¾ç¤ºç›¸åº”çš„é¡µé¢ï¼Œå¹¶ä¸”æ— é¡»åˆ·æ–°ã€‚ç›®å‰å•é¡µé¢ä½¿ç”¨çš„è·¯ç”±å°±åªæœ‰ä¸¤ç§å®ç°æ–¹å¼</p> <ul><li>hash æ¨¡å¼</li> <li>history æ¨¡å¼</li></ul> <p><code>www.test.com/#/</code> å°±æ˜¯ Hash URLï¼Œå½“ <code>#</code> åé¢çš„å“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¼šå‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ <code>hashchange</code> äº‹ä»¶æ¥ç›‘å¬åˆ° URL çš„å˜åŒ–ï¼Œä»è€Œè¿›è¡Œè·³è½¬é¡µé¢ã€‚</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042512.png" alt=""></p> <p>History æ¨¡å¼æ˜¯ HTML5 æ–°æ¨å‡ºçš„åŠŸèƒ½ï¼Œæ¯”ä¹‹ Hash URL æ›´åŠ ç¾è§‚</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042514.png" alt=""></p> <h1 id="virtual-dom"><a href="#virtual-dom" aria-hidden="true" class="header-anchor">#</a> Virtual Dom</h1> <p><a href="https://github.com/KieSun/My-wheels/tree/master/Virtual%20Dom" target="_blank" rel="noopener noreferrer">ä»£ç åœ°å€<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="ä¸ºä»€ä¹ˆéœ€è¦-virtual-dom"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-virtual-dom" aria-hidden="true" class="header-anchor">#</a> ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</h2> <p>ä¼—æ‰€å‘¨çŸ¥ï¼Œæ“ä½œ DOM æ˜¯å¾ˆè€—è´¹æ€§èƒ½çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘é€šè¿‡ JS å¯¹è±¡æ¥æ¨¡æ‹Ÿ DOM å¯¹è±¡ï¼Œæ¯•ç«Ÿæ“ä½œ JS å¯¹è±¡æ¯”æ“ä½œ DOM çœæ—¶çš„å¤šã€‚</p> <p>ä¸¾ä¸ªä¾‹å­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å‡è®¾è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ª ulï¼Œå…¶ä¸­åŒ…å«äº† 5 ä¸ª li</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
<span class="token comment">// è¿™é‡Œæ›¿æ¢ä¸Šé¢çš„ li</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre></div><p>ä»ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±å¯ä»¥çœ‹å‡ºå…ˆå‰çš„ ul ä¸­çš„ç¬¬ä¸‰ä¸ª li è¢«ç§»é™¤äº†ï¼Œå››äº”æ›¿æ¢äº†ä½ç½®ã€‚</p> <p>å¦‚æœä»¥ä¸Šæ“ä½œå¯¹åº”åˆ° DOM ä¸­ï¼Œé‚£ä¹ˆå°±æ˜¯ä»¥ä¸‹ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åˆ é™¤ç¬¬ä¸‰ä¸ª li</span>
ul<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// å°†ç¬¬å››ä¸ª li å’Œç¬¬äº”ä¸ªäº¤æ¢ä½ç½®</span>
<span class="token keyword">let</span> fromNode <span class="token operator">=</span> ul<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
</code></pre></div><p>å½“ç„¶åœ¨å®é™…æ“ä½œä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªæ ‡è¯†ï¼Œä½œä¸ºåˆ¤æ–­æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹çš„ä¾æ®ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯ Vue å’Œ React ä¸­å®˜æ–¹æ¨èåˆ—è¡¨é‡Œçš„èŠ‚ç‚¹ä½¿ç”¨å”¯ä¸€çš„ <code>key</code> æ¥ä¿è¯æ€§èƒ½ã€‚</p> <p>é‚£ä¹ˆæ—¢ç„¶ DOM å¯¹è±¡å¯ä»¥é€šè¿‡ JS å¯¹è±¡æ¥æ¨¡æ‹Ÿï¼Œåä¹‹ä¹Ÿå¯ä»¥é€šè¿‡ JS å¯¹è±¡æ¥æ¸²æŸ“å‡ºå¯¹åº”çš„ DOM</p> <p>ä»¥ä¸‹æ˜¯ä¸€ä¸ª JS å¯¹è±¡æ¨¡æ‹Ÿ DOM å¯¹è±¡çš„ç®€å•å®ç°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param {String} tag 'div'
   * @param {Object} props { class: 'item' }
   * @param {Array} children [ Element1, 'text']
   * @param {String} key option
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> children
      <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
  <span class="token punctuation">}</span>
  <span class="token comment">// æ¸²æŸ“</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key
    <span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token keyword">return</span> root
  <span class="token punctuation">}</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹</span>
  <span class="token function">_createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> child<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡ tag åˆ›å»ºèŠ‚ç‚¹</span>
    <span class="token keyword">let</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®èŠ‚ç‚¹å±æ€§</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é€’å½’æ·»åŠ å­èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      child<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> child
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span>
            element<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>key
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          child <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> el
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="virtual-dom-ç®—æ³•ç®€è¿°"><a href="#virtual-dom-ç®—æ³•ç®€è¿°" aria-hidden="true" class="header-anchor">#</a> Virtual Dom ç®—æ³•ç®€è¿°</h2> <p>æ—¢ç„¶æˆ‘ä»¬å·²ç»é€šè¿‡ JS æ¥æ¨¡æ‹Ÿå®ç°äº† DOMï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„éš¾ç‚¹å°±åœ¨äºå¦‚ä½•åˆ¤æ–­æ—§çš„å¯¹è±¡å’Œæ–°çš„å¯¹è±¡ä¹‹é—´çš„å·®å¼‚ã€‚</p> <p>DOM æ˜¯å¤šå‰æ ‘çš„ç»“æ„ï¼Œå¦‚æœéœ€è¦å®Œæ•´çš„å¯¹æ¯”ä¸¤é¢—æ ‘çš„å·®å¼‚ï¼Œé‚£ä¹ˆéœ€è¦çš„æ—¶é—´å¤æ‚åº¦ä¼šæ˜¯ O(n ^ 3)ï¼Œè¿™ä¸ªå¤æ‚åº¦è‚¯å®šæ˜¯ä¸èƒ½æ¥å—çš„ã€‚äºæ˜¯ React å›¢é˜Ÿä¼˜åŒ–äº†ç®—æ³•ï¼Œå®ç°äº† O(n) çš„å¤æ‚åº¦æ¥å¯¹æ¯”å·®å¼‚ã€‚</p> <p>å®ç° O(n) å¤æ‚åº¦çš„å…³é”®å°±æ˜¯åªå¯¹æ¯”åŒå±‚çš„èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯è·¨å±‚å¯¹æ¯”ï¼Œè¿™ä¹Ÿæ˜¯è€ƒè™‘åˆ°åœ¨å®é™…ä¸šåŠ¡ä¸­å¾ˆå°‘ä¼šå»è·¨å±‚çš„ç§»åŠ¨ DOM å…ƒç´ ã€‚</p> <p>æ‰€ä»¥åˆ¤æ–­å·®å¼‚çš„ç®—æ³•å°±åˆ†ä¸ºäº†ä¸¤æ­¥</p> <ul><li>é¦–å…ˆä»ä¸Šè‡³ä¸‹ï¼Œä»å·¦å¾€å³éå†å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ ‘çš„æ·±åº¦éå†ï¼Œè¿™ä¸€æ­¥ä¸­ä¼šç»™æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ç´¢å¼•ï¼Œä¾¿äºæœ€åæ¸²æŸ“å·®å¼‚</li> <li>ä¸€æ—¦èŠ‚ç‚¹æœ‰å­å…ƒç´ ï¼Œå°±å»åˆ¤æ–­å­å…ƒç´ æ˜¯å¦æœ‰ä¸åŒ</li></ul> <h2 id="virtual-dom-ç®—æ³•å®ç°"><a href="#virtual-dom-ç®—æ³•å®ç°" aria-hidden="true" class="header-anchor">#</a> Virtual Dom ç®—æ³•å®ç°</h2> <h3 id="æ ‘çš„é€’å½’"><a href="#æ ‘çš„é€’å½’" aria-hidden="true" class="header-anchor">#</a> æ ‘çš„é€’å½’</h3> <p>é¦–å…ˆæˆ‘ä»¬æ¥å®ç°æ ‘çš„é€’å½’ç®—æ³•ï¼Œåœ¨å®ç°è¯¥ç®—æ³•å‰ï¼Œå…ˆæ¥è€ƒè™‘ä¸‹ä¸¤ä¸ªèŠ‚ç‚¹å¯¹æ¯”ä¼šæœ‰å‡ ç§æƒ…å†µ</p> <ol><li>æ–°çš„èŠ‚ç‚¹çš„ <code>tagName</code> æˆ–è€… <code>key</code> å’Œæ—§çš„ä¸åŒï¼Œè¿™ç§æƒ…å†µä»£è¡¨éœ€è¦æ›¿æ¢æ—§çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¹Ÿä¸å†éœ€è¦éå†æ–°æ—§èŠ‚ç‚¹çš„å­å…ƒç´ äº†ï¼Œå› ä¸ºæ•´ä¸ªæ—§èŠ‚ç‚¹éƒ½è¢«åˆ æ‰äº†</li> <li>æ–°çš„èŠ‚ç‚¹çš„ <code>tagName</code> å’Œ <code>key</code>ï¼ˆå¯èƒ½éƒ½æ²¡æœ‰ï¼‰å’Œæ—§çš„ç›¸åŒï¼Œå¼€å§‹éå†å­æ ‘</li> <li>æ²¡æœ‰æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åš</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> StateEnums<span class="token punctuation">,</span> isString<span class="token punctuation">,</span> move <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>
<span class="token keyword">import</span> Element <span class="token keyword">from</span> <span class="token string">'./element'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">oldDomTree<span class="token punctuation">,</span> newDomTree</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºè®°å½•å·®å¼‚</span>
  <span class="token keyword">let</span> pathchs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ä¸€å¼€å§‹çš„ç´¢å¼•ä¸º 0</span>
  <span class="token function">dfs</span><span class="token punctuation">(</span>oldDomTree<span class="token punctuation">,</span> newDomTree<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pathchs<span class="token punctuation">)</span>
  <span class="token keyword">return</span> pathchs
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºä¿å­˜å­æ ‘çš„æ›´æ”¹</span>
  <span class="token keyword">let</span> curPatches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// éœ€è¦åˆ¤æ–­ä¸‰ç§æƒ…å†µ</span>
  <span class="token comment">// 1.æ²¡æœ‰æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åš</span>
  <span class="token comment">// 2.æ–°çš„èŠ‚ç‚¹çš„ tagName å’Œ `key` å’Œæ—§çš„ä¸åŒï¼Œå°±æ›¿æ¢</span>
  <span class="token comment">// 3.æ–°çš„èŠ‚ç‚¹çš„ tagName å’Œ keyï¼ˆå¯èƒ½éƒ½æ²¡æœ‰ï¼‰ å’Œæ—§çš„ç›¸åŒï¼Œå¼€å§‹éå†å­æ ‘</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> newNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å±æ€§æ˜¯å¦å˜æ›´</span>
    <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">diffProps</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>length<span class="token punctuation">)</span> curPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">,</span> props <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// éå†å­æ ‘</span>
    <span class="token function">diffChildren</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// èŠ‚ç‚¹ä¸åŒï¼Œéœ€è¦æ›¿æ¢</span>
    curPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">,</span> node<span class="token punctuation">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>curPatches<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>curPatches<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> curPatches
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="åˆ¤æ–­å±æ€§çš„æ›´æ”¹"><a href="#åˆ¤æ–­å±æ€§çš„æ›´æ”¹" aria-hidden="true" class="header-anchor">#</a> åˆ¤æ–­å±æ€§çš„æ›´æ”¹</h3> <p>åˆ¤æ–­å±æ€§çš„æ›´æ”¹ä¹Ÿåˆ†ä¸‰ä¸ªæ­¥éª¤</p> <ol><li>éå†æ—§çš„å±æ€§åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªå±æ€§æ˜¯å¦è¿˜å­˜åœ¨äºæ–°çš„å±æ€§åˆ—è¡¨ä¸­</li> <li>éå†æ–°çš„å±æ€§åˆ—è¡¨ï¼Œåˆ¤æ–­ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½å­˜åœ¨çš„å±æ€§çš„å€¼æ˜¯å¦æœ‰å˜åŒ–</li> <li>åœ¨ç¬¬äºŒæ­¥ä¸­åŒæ—¶æŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§ä¸å­˜åœ¨ä¸æ—§çš„å±æ€§åˆ—åˆ—è¡¨ä¸­</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ Props åˆ†ä»¥ä¸‹ä¸‰æ­¥éª¤</span>
  <span class="token comment">// å…ˆéå† oldProps æŸ¥çœ‹æ˜¯å¦å­˜åœ¨åˆ é™¤çš„å±æ€§</span>
  <span class="token comment">// ç„¶åéå† newProps æŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§å€¼è¢«ä¿®æ”¹</span>
  <span class="token comment">// æœ€åæŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§æ–°å¢</span>
  <span class="token keyword">let</span> change <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        prop<span class="token punctuation">:</span> key
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prop <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          prop<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
          value<span class="token punctuation">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          prop<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
          value<span class="token punctuation">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> change
<span class="token punctuation">}</span>

</code></pre></div><h3 id="åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°"><a href="#åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°" aria-hidden="true" class="header-anchor">#</a> åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</h3> <p>è¿™ä¸ªç®—æ³•æ˜¯æ•´ä¸ª Virtual Dom ä¸­æœ€æ ¸å¿ƒçš„ç®—æ³•ï¼Œä¸”è®©æˆ‘ä¸€ä¸€ä¸ºä½ é“æ¥ã€‚
è¿™é‡Œçš„ä¸»è¦æ­¥éª¤å…¶å®å’Œåˆ¤æ–­å±æ€§å·®å¼‚æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸‰æ­¥</p> <ol><li>éå†æ—§çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦è¿˜å­˜åœ¨äºæ–°çš„èŠ‚ç‚¹åˆ—è¡¨ä¸­</li> <li>éå†æ–°çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„èŠ‚ç‚¹</li> <li>åœ¨ç¬¬äºŒæ­¥ä¸­åŒæ—¶åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æœ‰ç§»åŠ¨</li></ol> <p>PSï¼šè¯¥ç®—æ³•åªå¯¹æœ‰ <code>key</code> çš„èŠ‚ç‚¹åšå¤„ç†</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">listDiff</span><span class="token punctuation">(</span><span class="token parameter">oldList<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸ºäº†éå†æ–¹ä¾¿ï¼Œå…ˆå–å‡ºä¸¤ä¸ª list çš„æ‰€æœ‰ keys</span>
  <span class="token keyword">let</span> oldKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>oldList<span class="token punctuation">)</span>
  <span class="token keyword">let</span> newKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>newList<span class="token punctuation">)</span>
  <span class="token keyword">let</span> changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// ç”¨äºä¿å­˜å˜æ›´åçš„èŠ‚ç‚¹æ•°æ®</span>
  <span class="token comment">// ä½¿ç”¨è¯¥æ•°ç»„ä¿å­˜æœ‰ä»¥ä¸‹å¥½å¤„</span>
  <span class="token comment">// 1.å¯ä»¥æ­£ç¡®è·å¾—è¢«åˆ é™¤èŠ‚ç‚¹ç´¢å¼•</span>
  <span class="token comment">// 2.äº¤æ¢èŠ‚ç‚¹ä½ç½®åªéœ€è¦æ“ä½œä¸€é DOM</span>
  <span class="token comment">// 3.ç”¨äº `diffChildren` å‡½æ•°ä¸­çš„åˆ¤æ–­ï¼Œåªéœ€è¦éå†</span>
  <span class="token comment">// ä¸¤ä¸ªæ ‘ä¸­éƒ½å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œè€Œå¯¹äºæ–°å¢æˆ–è€…åˆ é™¤çš„èŠ‚ç‚¹æ¥è¯´ï¼Œå®Œå…¨æ²¡å¿…è¦</span>
  <span class="token comment">// å†å»åˆ¤æ–­ä¸€é</span>
  <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  oldList <span class="token operator">&amp;&amp;</span>
    oldList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token comment">// å¯»æ‰¾æ–°çš„ children ä¸­æ˜¯å¦å«æœ‰å½“å‰èŠ‚ç‚¹</span>
      <span class="token comment">// æ²¡æœ‰çš„è¯éœ€è¦åˆ é™¤</span>
      <span class="token keyword">let</span> index <span class="token operator">=</span> newKeys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// éå†å˜æ›´åçš„æ•°ç»„</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> list<span class="token punctuation">.</span>length
  <span class="token comment">// å› ä¸ºåˆ é™¤æ•°ç»„å…ƒç´ æ˜¯ä¼šæ›´æ”¹ç´¢å¼•çš„</span>
  <span class="token comment">// æ‰€æœ‰ä»åå¾€å‰åˆ å¯ä»¥ä¿è¯ç´¢å¼•ä¸å˜</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨ç¤ºéœ€è¦åˆ é™¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">,</span>
        index<span class="token punctuation">:</span> i
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// éå†æ–°çš„ listï¼Œåˆ¤æ–­æ˜¯å¦æœ‰èŠ‚ç‚¹æ–°å¢æˆ–ç§»åŠ¨</span>
  <span class="token comment">// åŒæ—¶ä¹Ÿå¯¹ `list` åšèŠ‚ç‚¹æ–°å¢å’Œç§»åŠ¨èŠ‚ç‚¹çš„æ“ä½œ</span>
  newList <span class="token operator">&amp;&amp;</span>
    newList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token comment">// å¯»æ‰¾æ—§çš„ children ä¸­æ˜¯å¦å«æœ‰å½“å‰èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> index <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token comment">// æ²¡æ‰¾åˆ°ä»£è¡¨æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">,</span>
          node<span class="token punctuation">:</span> item<span class="token punctuation">,</span>
          index<span class="token punctuation">:</span> i
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰¾åˆ°äº†ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">,</span>
            <span class="token keyword">from</span><span class="token punctuation">:</span> index<span class="token punctuation">,</span>
            to<span class="token punctuation">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token function">move</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> index<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> text
  list <span class="token operator">&amp;&amp;</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token punctuation">}</span>
      keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> keys
<span class="token punctuation">}</span>
</code></pre></div><h3 id="éå†å­å…ƒç´ æ‰“æ ‡è¯†"><a href="#éå†å­å…ƒç´ æ‰“æ ‡è¯†" aria-hidden="true" class="header-anchor">#</a> éå†å­å…ƒç´ æ‰“æ ‡è¯†</h3> <p>å¯¹äºè¿™ä¸ªå‡½æ•°æ¥è¯´ï¼Œä¸»è¦åŠŸèƒ½å°±ä¸¤ä¸ª</p> <ol><li>åˆ¤æ–­ä¸¤ä¸ªåˆ—è¡¨å·®å¼‚</li> <li>ç»™èŠ‚ç‚¹æ‰“ä¸Šæ ‡è®°</li></ol> <p>æ€»ä½“æ¥è¯´ï¼Œè¯¥å‡½æ•°å®ç°çš„åŠŸèƒ½å¾ˆç®€å•</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">listDiff</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> changes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è®°å½•ä¸Šä¸€ä¸ªéå†è¿‡çš„èŠ‚ç‚¹</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  oldChild <span class="token operator">&amp;&amp;</span>
    oldChild<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> item <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>children
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">=</span>
          last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">let</span> keyIndex <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token keyword">let</span> node <span class="token operator">=</span> newChild<span class="token punctuation">[</span>keyIndex<span class="token punctuation">]</span>
        <span class="token comment">// åªéå†æ–°æ—§ä¸­éƒ½å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œå…¶ä»–æ–°å¢æˆ–è€…åˆ é™¤çš„æ²¡å¿…è¦éå†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">dfs</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> node<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> index <span class="token operator">+=</span> <span class="token number">1</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="æ¸²æŸ“å·®å¼‚"><a href="#æ¸²æŸ“å·®å¼‚" aria-hidden="true" class="header-anchor">#</a> æ¸²æŸ“å·®å¼‚</h3> <p>é€šè¿‡ä¹‹å‰çš„ç®—æ³•ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¾—å‡ºä¸¤ä¸ªæ ‘çš„å·®å¼‚äº†ã€‚æ—¢ç„¶çŸ¥é“äº†å·®å¼‚ï¼Œå°±éœ€è¦å±€éƒ¨å»æ›´æ–° DOM äº†ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Virtual Dom ç®—æ³•çš„æœ€åä¸€æ­¥éª¤</p> <p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä¸¤ä¸ªåŠŸèƒ½</p> <ol><li>æ·±åº¦éå†æ ‘ï¼Œå°†éœ€è¦åšå˜æ›´æ“ä½œçš„å–å‡ºæ¥</li> <li>å±€éƒ¨æ›´æ–° DOM</li></ol> <p>æ•´ä½“æ¥è¯´è¿™éƒ¨åˆ†ä»£ç è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patchs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> changes <span class="token operator">=</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  <span class="token keyword">let</span> childNodes <span class="token operator">=</span> node <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes
  <span class="token comment">// è¿™é‡Œçš„æ·±åº¦éå†å’Œ diff ä¸­æ˜¯ä¸€æ ·çš„</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childNodes<span class="token punctuation">)</span> index <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">&amp;&amp;</span> changes<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">changeDom</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> changes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childNodes <span class="token operator">&amp;&amp;</span> childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      index <span class="token operator">=</span>
        last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> patchs<span class="token punctuation">)</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">changeDom</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> changes<span class="token punctuation">,</span> noChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  changes <span class="token operator">&amp;&amp;</span>
    changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> change
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">:</span>
          <span class="token keyword">let</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> change
          props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">,</span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">:</span>
          node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">:</span>
          <span class="token keyword">let</span> dom
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dom <span class="token operator">=</span> change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">:</span>
          node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">:</span>
          <span class="token keyword">let</span> fromNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>from<span class="token punctuation">]</span>
          <span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>to<span class="token punctuation">]</span>
          <span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
          node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="æœ€å"><a href="#æœ€å" aria-hidden="true" class="header-anchor">#</a> æœ€å</h2> <p>Virtual Dom ç®—æ³•çš„å®ç°ä¹Ÿå°±æ˜¯ä»¥ä¸‹ä¸‰æ­¥</p> <ol><li>é€šè¿‡ JS æ¥æ¨¡æ‹Ÿåˆ›å»º DOM å¯¹è±¡</li> <li>åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„å·®å¼‚</li> <li>æ¸²æŸ“å·®å¼‚</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> test4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test4'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> test5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test5'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> test1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test4<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> test2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'11'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test5<span class="token punctuation">,</span> test4<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> root <span class="token operator">=</span> test1<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> pathchs <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>test1<span class="token punctuation">,</span> test2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pathchs<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'å¼€å§‹æ›´æ–°'</span><span class="token punctuation">)</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> pathchs<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ç»“æŸæ›´æ–°'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><p>å½“ç„¶ç›®å‰çš„å®ç°è¿˜ç•¥æ˜¾ç²—ç³™ï¼Œä½†æ˜¯å¯¹äºç†è§£ Virtual Dom ç®—æ³•æ¥è¯´å·²ç»æ˜¯å®Œå…¨è¶³å¤Ÿçš„äº†ã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.33c008d4.js" defer></script><script src="/assets/js/2.f6583267.js" defer></script><script src="/assets/js/14.1f821c0e.js" defer></script>
  </body>
</html>
