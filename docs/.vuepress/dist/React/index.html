<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ</title>
    <meta name="description" content="å‰ç«¯åšå®¢ä¹‹å®¶">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.1b45e88d.css" as="style"><link rel="preload" href="/assets/js/app.a63f8372.js" as="script"><link rel="preload" href="/assets/js/2.f6583267.js" as="script"><link rel="preload" href="/assets/js/13.b9dfc02e.js" as="script"><link rel="prefetch" href="/assets/js/10.03411910.js"><link rel="prefetch" href="/assets/js/11.b50276d2.js"><link rel="prefetch" href="/assets/js/12.b90513f5.js"><link rel="prefetch" href="/assets/js/14.93339a8b.js"><link rel="prefetch" href="/assets/js/15.26cc08de.js"><link rel="prefetch" href="/assets/js/16.b3690256.js"><link rel="prefetch" href="/assets/js/17.1c855a6b.js"><link rel="prefetch" href="/assets/js/18.a1bb8bf6.js"><link rel="prefetch" href="/assets/js/19.10cb7188.js"><link rel="prefetch" href="/assets/js/20.8281acf4.js"><link rel="prefetch" href="/assets/js/3.4ec713e1.js"><link rel="prefetch" href="/assets/js/4.b6f69170.js"><link rel="prefetch" href="/assets/js/5.2c36c48a.js"><link rel="prefetch" href="/assets/js/6.f5b28974.js"><link rel="prefetch" href="/assets/js/7.07089d4e.js"><link rel="prefetch" href="/assets/js/8.2a0cb71a.js"><link rel="prefetch" href="/assets/js/9.d988cfc8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b45e88d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://cdn.sunkb.cn/è‡ªæ‹sun.jpeg" alt="å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ" class="logo"> <span class="site-name can-hide">å­™æŸ¯å®å‰ç«¯èœ—ç‰›ğŸŒ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://www.sunkb.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æˆ‘çš„ä¸ªäººå®˜ç½‘
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/JS/" class="nav-link">JSåŸºç¡€</a></div><div class="nav-item"><a href="/Vue/vue.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/React/" class="nav-link router-link-exact-active router-link-active">ReactåŠè§£</a></div><div class="nav-item"><a href="/Network/" class="nav-link">è®¡ç®—æœºç½‘ç»œ</a></div><div class="nav-item"><a href="/Browser/browser.html" class="nav-link">æµè§ˆå™¨</a></div><div class="nav-item"><a href="/Safety/safe.html" class="nav-link">ç½‘ç»œå®‰å…¨</a></div><div class="nav-item"><a href="/Performance/performance.html" class="nav-link">æ€§èƒ½ä¼˜åŒ–ç‚¹</a></div><div class="nav-item"><a href="/Datastruct/datastruct.html" class="nav-link">æ•°æ®ç»“æ„</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">ç®—æ³•</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://www.sunkb.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æˆ‘çš„ä¸ªäººå®˜ç½‘
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/JS/" class="nav-link">JSåŸºç¡€</a></div><div class="nav-item"><a href="/Vue/vue.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/React/" class="nav-link router-link-exact-active router-link-active">ReactåŠè§£</a></div><div class="nav-item"><a href="/Network/" class="nav-link">è®¡ç®—æœºç½‘ç»œ</a></div><div class="nav-item"><a href="/Browser/browser.html" class="nav-link">æµè§ˆå™¨</a></div><div class="nav-item"><a href="/Safety/safe.html" class="nav-link">ç½‘ç»œå®‰å…¨</a></div><div class="nav-item"><a href="/Performance/performance.html" class="nav-link">æ€§èƒ½ä¼˜åŒ–ç‚¹</a></div><div class="nav-item"><a href="/Datastruct/datastruct.html" class="nav-link">æ•°æ®ç»“æ„</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">ç®—æ³•</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/#react-ç”Ÿå‘½å‘¨æœŸåˆ†æ" class="sidebar-link">React ç”Ÿå‘½å‘¨æœŸåˆ†æ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/React/#v16-ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç”¨æ³•å»ºè®®" class="sidebar-link">V16 ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç”¨æ³•å»ºè®®</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/React/#setstate" class="sidebar-link">setState</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/React/#redux-æºç åˆ†æ" class="sidebar-link">Redux æºç åˆ†æ</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="react-ç”Ÿå‘½å‘¨æœŸåˆ†æ"><a href="#react-ç”Ÿå‘½å‘¨æœŸåˆ†æ" aria-hidden="true" class="header-anchor">#</a> React ç”Ÿå‘½å‘¨æœŸåˆ†æ</h2> <p>åœ¨ V16 ç‰ˆæœ¬ä¸­å¼•å…¥äº† Fiber æœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶ä¸€å®šç¨‹åº¦ä¸Šçš„å½±å“äº†éƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨ï¼Œå¹¶ä¸”ä¹Ÿå¼•å…¥äº†æ–°çš„ 2 ä¸ª API æ¥è§£å†³é—®é¢˜ã€‚</p> <p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä½ æ‹¥æœ‰ä¸€ä¸ªå¾ˆå¤æ‚çš„å¤åˆç»„ä»¶ï¼Œç„¶åæ”¹åŠ¨äº†æœ€ä¸Šå±‚ç»„ä»¶çš„ <code>state</code>ï¼Œé‚£ä¹ˆè°ƒç”¨æ ˆå¯èƒ½ä¼šå¾ˆé•¿</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042522.png" alt=""></p> <p>è°ƒç”¨æ ˆè¿‡é•¿ï¼Œå†åŠ ä¸Šä¸­é—´è¿›è¡Œäº†å¤æ‚çš„æ“ä½œï¼Œå°±å¯èƒ½å¯¼è‡´é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹ï¼Œå¸¦æ¥ä¸å¥½çš„ç”¨æˆ·ä½“éªŒã€‚Fiber å°±æ˜¯ä¸ºäº†è§£å†³è¯¥é—®é¢˜è€Œç”Ÿã€‚</p> <p>Fiber æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„å †æ ˆå¸§ï¼Œæ–°çš„è°ƒåº¦å™¨ä¼šæŒ‰ç…§ä¼˜å…ˆçº§è‡ªç”±è°ƒåº¦è¿™äº›å¸§ï¼Œä»è€Œå°†ä¹‹å‰çš„åŒæ­¥æ¸²æŸ“æ”¹æˆäº†å¼‚æ­¥æ¸²æŸ“ï¼Œåœ¨ä¸å½±å“ä½“éªŒçš„æƒ…å†µä¸‹å»åˆ†æ®µè®¡ç®—æ›´æ–°ã€‚</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-042523.png" alt=""></p> <p>å¯¹äºå¦‚ä½•åŒºåˆ«ä¼˜å…ˆçº§ï¼ŒReact æœ‰è‡ªå·±çš„ä¸€å¥—é€»è¾‘ã€‚å¯¹äºåŠ¨ç”»è¿™ç§å®æ—¶æ€§å¾ˆé«˜çš„ä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯ 16 ms å¿…é¡»æ¸²æŸ“ä¸€æ¬¡ä¿è¯ä¸å¡é¡¿çš„æƒ…å†µä¸‹ï¼ŒReact ä¼šæ¯ 16 msï¼ˆä»¥å†…ï¼‰ æš‚åœä¸€ä¸‹æ›´æ–°ï¼Œè¿”å›æ¥ç»§ç»­æ¸²æŸ“åŠ¨ç”»ã€‚</p> <p>å¯¹äºå¼‚æ­¥æ¸²æŸ“ï¼Œç°åœ¨æ¸²æŸ“æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š<code>reconciliation</code> å’Œ <code>commit</code> ã€‚å‰è€…è¿‡ç¨‹æ˜¯å¯ä»¥æ‰“æ–­çš„ï¼Œåè€…ä¸èƒ½æš‚åœï¼Œä¼šä¸€ç›´æ›´æ–°ç•Œé¢ç›´åˆ°å®Œæˆã€‚</p> <p><strong>Reconciliation</strong> é˜¶æ®µ</p> <ul><li><code>componentWillMount</code></li> <li><code>componentWillReceiveProps</code></li> <li><code>shouldComponentUpdate</code></li> <li><code>componentWillUpdate</code></li></ul> <p><strong>Commit</strong> é˜¶æ®µ</p> <ul><li><code>componentDidMount</code></li> <li><code>componentDidUpdate</code></li> <li><code>componentWillUnmount</code></li></ul> <p>å› ä¸º <code>reconciliation</code> é˜¶æ®µæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ‰€ä»¥ <code>reconciliation</code> é˜¶æ®µä¼šæ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°å°±å¯èƒ½ä¼šå‡ºç°è°ƒç”¨å¤šæ¬¡çš„æƒ…å†µï¼Œä»è€Œå¼•èµ· Bugã€‚æ‰€ä»¥å¯¹äº <code>reconciliation</code> é˜¶æ®µè°ƒç”¨çš„å‡ ä¸ªå‡½æ•°ï¼Œé™¤äº† <code>shouldComponentUpdate</code> ä»¥å¤–ï¼Œå…¶ä»–éƒ½åº”è¯¥é¿å…å»ä½¿ç”¨ï¼Œå¹¶ä¸” V16 ä¸­ä¹Ÿå¼•å…¥äº†æ–°çš„ API æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p> <p><code>getDerivedStateFromProps</code> ç”¨äºæ›¿æ¢ <code>componentWillReceiveProps</code> ï¼Œè¯¥å‡½æ•°ä¼šåœ¨åˆå§‹åŒ–å’Œ <code>update</code> æ—¶è¢«è°ƒç”¨</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// Initialize state in constructor,</span>
  <span class="token comment">// Or with a property initializer.</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>someMirroredValue <span class="token operator">!==</span> nextProps<span class="token punctuation">.</span>someValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        derivedData<span class="token punctuation">:</span> <span class="token function">computeDerivedState</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
        someMirroredValue<span class="token punctuation">:</span> nextProps<span class="token punctuation">.</span>someValue
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Return null to indicate no change to state.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>getSnapshotBeforeUpdate</code> ç”¨äºæ›¿æ¢ <code>componentWillUpdate</code> ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ <code>update</code> å DOM æ›´æ–°å‰è¢«è°ƒç”¨ï¼Œç”¨äºè¯»å–æœ€æ–°çš„ DOM æ•°æ®ã€‚</p> <h2 id="v16-ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç”¨æ³•å»ºè®®"><a href="#v16-ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç”¨æ³•å»ºè®®" aria-hidden="true" class="header-anchor">#</a> V16 ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç”¨æ³•å»ºè®®</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºåˆå§‹åŒ– state</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ç”¨äºæ›¿æ¢ `componentWillReceiveProps` ï¼Œè¯¥å‡½æ•°ä¼šåœ¨åˆå§‹åŒ–å’Œ `update` æ—¶è¢«è°ƒç”¨</span>
  <span class="token comment">// å› ä¸ºè¯¥å‡½æ•°æ˜¯é™æ€å‡½æ•°ï¼Œæ‰€ä»¥å–ä¸åˆ° `this`</span>
  <span class="token comment">// å¦‚æœéœ€è¦å¯¹æ¯” `prevProps` éœ€è¦å•ç‹¬åœ¨ `state` ä¸­ç»´æŠ¤</span>
  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ç»„ä»¶ï¼Œå¤šç”¨äºç»„ä»¶æ€§èƒ½ä¼˜åŒ–</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ç»„ä»¶æŒ‚è½½åè°ƒç”¨</span>
  <span class="token comment">// å¯ä»¥åœ¨è¯¥å‡½æ•°ä¸­è¿›è¡Œè¯·æ±‚æˆ–è€…è®¢é˜…</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ç”¨äºè·å¾—æœ€æ–°çš„ DOM æ•°æ®</span>
  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ç»„ä»¶å³å°†é”€æ¯</span>
  <span class="token comment">// å¯ä»¥åœ¨æ­¤å¤„ç§»é™¤è®¢é˜…ï¼Œå®šæ—¶å™¨ç­‰ç­‰</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ç»„ä»¶é”€æ¯åè°ƒç”¨</span>
  <span class="token function">componentDidUnMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ç»„ä»¶æ›´æ–°åè°ƒç”¨</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// æ¸²æŸ“ç»„ä»¶å‡½æ•°</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ä»¥ä¸‹å‡½æ•°ä¸å»ºè®®ä½¿ç”¨</span>
  <span class="token function">UNSAFE_componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">UNSAFE_componentWillUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">UNSAFE_componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="setstate"><a href="#setstate" aria-hidden="true" class="header-anchor">#</a> setState</h2> <p><code>setState</code> åœ¨ React ä¸­æ˜¯ç»å¸¸ä½¿ç”¨çš„ä¸€ä¸ª APIï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´çŠ¯é”™ï¼Œæ ¸å¿ƒåŸå› å°±æ˜¯å› ä¸ºè¿™ä¸ª API æ˜¯å¼‚æ­¥çš„ã€‚</p> <p>é¦–å…ˆ <code>setState</code> çš„è°ƒç”¨å¹¶ä¸ä¼šé©¬ä¸Šå¼•èµ· <code>state</code> çš„æ”¹å˜ï¼Œå¹¶ä¸”å¦‚æœä½ ä¸€æ¬¡è°ƒç”¨äº†å¤šä¸ª <code>setState</code> ï¼Œé‚£ä¹ˆç»“æœå¯èƒ½å¹¶ä¸å¦‚ä½ æœŸå¾…çš„ä¸€æ ·ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆå§‹åŒ– `count` ä¸º 0</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment">// -&gt; 0</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment">// -&gt; 0</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç¬¬ä¸€ï¼Œä¸¤æ¬¡çš„æ‰“å°éƒ½ä¸º 0ï¼Œå› ä¸º <code>setState</code> æ˜¯ä¸ªå¼‚æ­¥ APIï¼Œåªæœ‰åŒæ­¥ä»£ç è¿è¡Œå®Œæ¯•æ‰ä¼šæ‰§è¡Œã€‚<code>setState</code> å¼‚æ­¥çš„åŸå› æˆ‘è®¤ä¸ºåœ¨äºï¼Œ<code>setState</code> å¯èƒ½ä¼šå¯¼è‡´ DOM çš„é‡ç»˜ï¼Œå¦‚æœè°ƒç”¨ä¸€æ¬¡å°±é©¬ä¸Šå»è¿›è¡Œé‡ç»˜ï¼Œé‚£ä¹ˆè°ƒç”¨å¤šæ¬¡å°±ä¼šé€ æˆä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ã€‚è®¾è®¡æˆå¼‚æ­¥çš„è¯ï¼Œå°±å¯ä»¥å°†å¤šæ¬¡è°ƒç”¨æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œåœ¨æ°å½“çš„æ—¶å€™ç»Ÿä¸€è¿›è¡Œæ›´æ–°è¿‡ç¨‹ã€‚</p> <p>ç¬¬äºŒï¼Œè™½ç„¶è°ƒç”¨äº†ä¸‰æ¬¡ <code>setState</code> ï¼Œä½†æ˜¯ <code>count</code> çš„å€¼è¿˜æ˜¯ä¸º 1ã€‚å› ä¸ºå¤šæ¬¡è°ƒç”¨ä¼šåˆå¹¶ä¸ºä¸€æ¬¡ï¼Œåªæœ‰å½“æ›´æ–°ç»“æŸå <code>state</code> æ‰ä¼šæ”¹å˜ï¼Œä¸‰æ¬¡è°ƒç”¨ç­‰åŒäºå¦‚ä¸‹ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>  
  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥å®ç°è°ƒç”¨ä¸‰æ¬¡ <code>setState</code> ä½¿å¾— <code>count</code> ä¸º 3</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœä½ æƒ³åœ¨æ¯æ¬¡è°ƒç”¨ <code>setState</code> åè·å¾—æ­£ç¡®çš„ <code>state</code> ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å®ç°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="redux-æºç åˆ†æ"><a href="#redux-æºç åˆ†æ" aria-hidden="true" class="header-anchor">#</a> Redux æºç åˆ†æ</h2> <p>é¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>combineReducers</code> å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ä¼ å…¥ä¸€ä¸ª object</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// è·å–è¯¥ Object çš„ key å€¼</span>
  <span class="token keyword">const</span> reducerKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span>
  <span class="token comment">// è¿‡æ»¤åçš„ reducers</span>
  <span class="token keyword">const</span> finalReducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// è·å–æ¯ä¸€ä¸ª key å¯¹åº”çš„ value</span>
  <span class="token comment">// åœ¨å¼€å‘ç¯å¢ƒä¸‹åˆ¤æ–­å€¼æ˜¯å¦ä¸º undefined</span>
  <span class="token comment">// ç„¶åå°†å€¼ç±»å‹æ˜¯å‡½æ•°çš„å€¼æ”¾å…¥ finalReducers</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> reducerKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> reducerKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warning</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No reducer provided for key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      finalReducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ‹¿åˆ°è¿‡æ»¤åçš„ reducers çš„ key å€¼</span>
  <span class="token keyword">const</span> finalReducerKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>finalReducers<span class="token punctuation">)</span>
  
  <span class="token comment">// åœ¨å¼€å‘ç¯å¢ƒä¸‹åˆ¤æ–­ï¼Œä¿å­˜ä¸æœŸæœ› key çš„ç¼“å­˜ç”¨ä»¥ä¸‹é¢åšè­¦å‘Š  </span>
  <span class="token keyword">let</span> unexpectedKeyCache
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unexpectedKeyCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    
  <span class="token keyword">let</span> shapeAssertionError
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¯¥å‡½æ•°è§£æåœ¨ä¸‹é¢</span>
    <span class="token function">assertReducerShape</span><span class="token punctuation">(</span>finalReducers<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shapeAssertionError <span class="token operator">=</span> e
  <span class="token punctuation">}</span>
<span class="token comment">// combineReducers å‡½æ•°è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åˆå¹¶åçš„ reducer å‡½æ•°</span>
<span class="token comment">// è¯¥å‡½æ•°è¿”å›æ€»çš„ state</span>
<span class="token comment">// å¹¶ä¸”ä½ ä¹Ÿå¯ä»¥å‘ç°è¿™é‡Œä½¿ç”¨äº†é—­åŒ…ï¼Œå‡½æ•°é‡Œé¢ä½¿ç”¨åˆ°äº†å¤–é¢çš„ä¸€äº›å±æ€§</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">combination</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeAssertionError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> shapeAssertionError
    <span class="token punctuation">}</span>
    <span class="token comment">// è¯¥å‡½æ•°è§£æåœ¨ä¸‹é¢</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> warningMessage <span class="token operator">=</span> <span class="token function">getUnexpectedStateShapeWarningMessage</span><span class="token punctuation">(</span>
        state<span class="token punctuation">,</span>
        finalReducers<span class="token punctuation">,</span>
        action<span class="token punctuation">,</span>
        unexpectedKeyCache
      <span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>warningMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warning</span><span class="token punctuation">(</span>warningMessage<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// state æ˜¯å¦æ”¹å˜</span>
    <span class="token keyword">let</span> hasChanged <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// æ”¹å˜åçš„ state</span>
    <span class="token keyword">const</span> nextState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> finalReducerKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°ç›¸åº”çš„ key</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> finalReducerKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token comment">// è·å¾— key å¯¹åº”çš„ reducer å‡½æ•°</span>
      <span class="token keyword">const</span> reducer <span class="token operator">=</span> finalReducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// state æ ‘ä¸‹çš„ key æ˜¯ä¸ finalReducers ä¸‹çš„ key ç›¸åŒçš„</span>
      <span class="token comment">// æ‰€ä»¥ä½ åœ¨ combineReducers ä¸­ä¼ å…¥çš„å‚æ•°çš„ key å³ä»£è¡¨äº† å„ä¸ª reducer ä¹Ÿä»£è¡¨äº†å„ä¸ª state</span>
      <span class="token keyword">const</span> previousStateForKey <span class="token operator">=</span> state<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// ç„¶åæ‰§è¡Œ reducer å‡½æ•°è·å¾—è¯¥ key å€¼å¯¹åº”çš„ state</span>
      <span class="token keyword">const</span> nextStateForKey <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>previousStateForKey<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
      <span class="token comment">// åˆ¤æ–­ state çš„å€¼ï¼Œundefined çš„è¯å°±æŠ¥é”™</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextStateForKey <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> errorMessage <span class="token operator">=</span> <span class="token function">getUndefinedStateErrorMessage</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ç„¶åå°† value å¡è¿›å»</span>
      nextState<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> nextStateForKey
      <span class="token comment">// å¦‚æœ state æ”¹å˜</span>
      hasChanged <span class="token operator">=</span> hasChanged <span class="token operator">||</span> nextStateForKey <span class="token operator">!==</span> previousStateForKey
    <span class="token punctuation">}</span>
    <span class="token comment">// state åªè¦æ”¹å˜è¿‡ï¼Œå°±è¿”å›æ–°çš„ state</span>
    <span class="token keyword">return</span> hasChanged <span class="token operator">?</span> nextState <span class="token punctuation">:</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>combineReducers</code> å‡½æ•°æ€»çš„æ¥è¯´å¾ˆç®€å•ï¼Œæ€»ç»“æ¥è¯´å°±æ˜¯æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ï¼Œå°†å‚æ•°è¿‡æ»¤åè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚è¯¥å‡½æ•°é‡Œæœ‰ä¸€ä¸ªè¿‡æ»¤å‚æ•°åçš„å¯¹è±¡ finalReducersï¼Œéå†è¯¥å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œå¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ª reducer å‡½æ•°ï¼Œæœ€åå°†æ–°çš„ state è¿”å›ã€‚</p> <p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹ combinrReducers ä¸­ç”¨åˆ°çš„ä¸¤ä¸ªå‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è¿™æ˜¯æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªç”¨äºæŠ›é”™çš„å‡½æ•°</span>
<span class="token keyword">function</span> <span class="token function">assertReducerShape</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// å°† combineReducers ä¸­çš„å‚æ•°éå†</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> reducer <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// ç»™ä»–ä¼ å…¥ä¸€ä¸ª action</span>
    <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// å¦‚æœå¾—åˆ°çš„ state ä¸º undefined å°±æŠ›é”™</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reducer &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; returned undefined during initialization. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">If the state passed to the reducer is undefined, you must </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">explicitly return the initial state. The initial state may </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not be undefined. If you don't want to set a value for this reducer, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">you can use null instead of undefined.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å†è¿‡æ»¤ä¸€æ¬¡ï¼Œè€ƒè™‘åˆ°ä¸‡ä¸€ä½ åœ¨ reducer ä¸­ç»™ ActionTypes.INIT è¿”å›äº†å€¼</span>
    <span class="token comment">// ä¼ å…¥ä¸€ä¸ªéšæœºçš„ action åˆ¤æ–­å€¼æ˜¯å¦ä¸º undefined</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span>
      <span class="token string">'@@redux/PROBE_UNKNOWN_ACTION_'</span> <span class="token operator">+</span>
      Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reducer &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; returned undefined when probed with a random type. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Don't try to handle </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
            ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span>
          <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> or other actions in &quot;redux/*&quot; </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">namespace. They are considered private. Instead, you must return the </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">current state for any unknown actions, unless it is undefined, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">in which case you must return the initial state, regardless of the </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action type. The initial state may not be undefined, but can be null.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getUnexpectedStateShapeWarningMessage</span><span class="token punctuation">(</span>
  <span class="token parameter">inputState<span class="token punctuation">,</span>
  reducers<span class="token punctuation">,</span>
  action<span class="token punctuation">,</span>
  unexpectedKeyCache</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œçš„ reducers å·²ç»æ˜¯ finalReducers</span>
  <span class="token keyword">const</span> reducerKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span>
  <span class="token keyword">const</span> argumentName <span class="token operator">=</span>
    action <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span>type <span class="token operator">===</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span>
      <span class="token operator">?</span> <span class="token string">'preloadedState argument passed to createStore'</span>
      <span class="token punctuation">:</span> <span class="token string">'previous state received by the reducer'</span>
  
  <span class="token operator">/</span><span class="token operator">/</span> å¦‚æœ finalReducers ä¸ºç©º
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reducerKeys<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token string">'Store does not have a valid reducer. Make sure the argument passed '</span> <span class="token operator">+</span>
      <span class="token string">'to combineReducers is an object whose values are reducers.'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> å¦‚æœä½ ä¼ å…¥çš„ state ä¸æ˜¯å¯¹è±¡
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argumentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has unexpected type of &quot;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\s([a-z|A-Z]+)/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;. Expected argument to be an object with the following </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">keys: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reducerKeys<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&quot;, &quot;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> å°†å‚å…¥çš„ state äº finalReducers ä¸‹çš„ key åšæ¯”è¾ƒï¼Œè¿‡æ»¤å‡ºå¤šä½™çš„ key
  <span class="token keyword">const</span> unexpectedKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
    <span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>reducers<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>unexpectedKeyCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">)</span>

  unexpectedKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    unexpectedKeyCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span>type <span class="token operator">===</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">REPLACE</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

<span class="token operator">/</span><span class="token operator">/</span> å¦‚æœ unexpectedKeys æœ‰å€¼çš„è¯
  <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unexpected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unexpectedKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'keys'</span> <span class="token punctuation">:</span> <span class="token string">'key'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unexpectedKeys<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&quot;, &quot;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; found in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argumentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected to find one of the known reducer keys instead: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reducerKeys<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&quot;, &quot;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Unexpected keys will be ignored.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>compose</code> å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è¿™ä¸ªå‡½æ•°è®¾è®¡çš„å¾ˆå·§å¦™ï¼Œé€šè¿‡ä¼ å…¥å‡½æ•°å¼•ç”¨çš„æ–¹å¼è®©æˆ‘ä»¬å®Œæˆå¤šä¸ªå‡½æ•°çš„åµŒå¥—ä½¿ç”¨ï¼Œæœ¯è¯­å«åšé«˜é˜¶å‡½æ•°</span>
<span class="token comment">// é€šè¿‡ä½¿ç”¨ reduce å‡½æ•°åšåˆ°ä»å³è‡³å·¦è°ƒç”¨å‡½æ•°</span>
<span class="token comment">// å¯¹äºä¸Šé¢é¡¹ç›®ä¸­çš„ä¾‹å­</span>
<span class="token function">compose</span><span class="token punctuation">(</span>
    <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunkMiddleware<span class="token punctuation">)</span><span class="token punctuation">,</span>
    window<span class="token punctuation">.</span>devToolsExtension <span class="token operator">?</span> window<span class="token punctuation">.</span><span class="token function">devToolsExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token parameter">f</span> <span class="token operator">=&gt;</span> f
<span class="token punctuation">)</span> 
<span class="token comment">// ç»è¿‡ compose å‡½æ•°å˜æˆäº† applyMiddleware(thunkMiddleware)(window.devToolsExtension()())</span>
<span class="token comment">// æ‰€ä»¥åœ¨æ‰¾ä¸åˆ° window.devToolsExtension æ—¶ä½ åº”è¯¥è¿”å›ä¸€ä¸ªå‡½æ•°</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> arg
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶åæˆ‘ä»¬æ¥è§£æ <code>createStore</code> å‡½æ•°çš„éƒ¨åˆ†ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> preloadedState<span class="token punctuation">,</span> enhancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸€èˆ¬ preloadedState ç”¨çš„å°‘ï¼Œåˆ¤æ–­ç±»å‹ï¼Œå¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°ä¸”æ²¡æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå°±è°ƒæ¢ä½ç½®</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> preloadedState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> enhancer <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    enhancer <span class="token operator">=</span> preloadedState
    preloadedState <span class="token operator">=</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ¤æ–­ enhancer æ˜¯å¦æ˜¯å‡½æ•°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the enhancer to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç±»å‹æ²¡é”™çš„è¯ï¼Œå…ˆæ‰§è¡Œ enhancerï¼Œç„¶åå†æ‰§è¡Œ createStore å‡½æ•°</span>
    <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> preloadedState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ¤æ–­ reducer æ˜¯å¦æ˜¯å‡½æ•°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reducer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the reducer to be a function.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å½“å‰ reducer</span>
  <span class="token keyword">let</span> currentReducer <span class="token operator">=</span> reducer
  <span class="token comment">// å½“å‰çŠ¶æ€</span>
  <span class="token keyword">let</span> currentState <span class="token operator">=</span> preloadedState
  <span class="token comment">// å½“å‰ç›‘å¬å‡½æ•°æ•°ç»„</span>
  <span class="token keyword">let</span> currentListeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„è®¾è®¡ï¼Œä¸ºçš„å°±æ˜¯æ¯æ¬¡åœ¨éå†ç›‘å¬å™¨çš„æ—¶å€™ä¿è¯ currentListeners æ•°ç»„ä¸å˜</span>
  <span class="token comment">// å¯ä»¥è€ƒè™‘ä¸‹åªå­˜åœ¨ currentListeners çš„æƒ…å†µï¼Œå¦‚æœæˆ‘åœ¨æŸä¸ª subscribe ä¸­å†æ¬¡æ‰§è¡Œ subscribe</span>
  <span class="token comment">// æˆ–è€… unsubscribeï¼Œè¿™æ ·ä¼šå¯¼è‡´å½“å‰çš„ currentListeners æ•°ç»„å¤§å°å‘ç”Ÿæ”¹å˜ï¼Œä»è€Œå¯èƒ½å¯¼è‡´</span>
  <span class="token comment">// ç´¢å¼•å‡ºé”™</span>
  <span class="token keyword">let</span> nextListeners <span class="token operator">=</span> currentListeners
  <span class="token comment">// reducer æ˜¯å¦æ­£åœ¨æ‰§è¡Œ</span>
  <span class="token keyword">let</span> isDispatching <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token comment">// å¦‚æœ currentListeners å’Œ nextListeners ç›¸åŒï¼Œå°±èµ‹å€¼å›å»</span>
  <span class="token keyword">function</span> <span class="token function">ensureCanMutateNextListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextListeners <span class="token operator">===</span> currentListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextListeners <span class="token operator">=</span> currentListeners<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥å…ˆæ¥ä»‹ç» <code>applyMiddleware</code> å‡½æ•°</p> <p>åœ¨è¿™ä¹‹å‰æˆ‘éœ€è¦å…ˆæ¥ä»‹ç»ä¸€ä¸‹å‡½æ•°æŸ¯é‡ŒåŒ–ï¼ŒæŸ¯é‡ŒåŒ–æ˜¯ä¸€ç§å°†ä½¿ç”¨å¤šä¸ªå‚æ•°çš„ä¸€ä¸ªå‡½æ•°è½¬æ¢æˆä¸€ç³»åˆ—ä½¿ç”¨ä¸€ä¸ªå‚æ•°çš„å‡½æ•°çš„æŠ€æœ¯ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token punctuation">}</span>   
<span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">3</span>
<span class="token comment">// å¯¹äºä»¥ä¸Šå‡½æ•°å¦‚æœä½¿ç”¨æŸ¯é‡ŒåŒ–å¯ä»¥è¿™æ ·æ”¹é€ </span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token parameter">b</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">3</span>
<span class="token comment">// ä½ å¯ä»¥è¿™æ ·ç†è§£å‡½æ•°æŸ¯é‡ŒåŒ–ï¼Œé€šè¿‡é—­åŒ…ä¿å­˜äº†å¤–éƒ¨çš„ä¸€ä¸ªå˜é‡ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ¥æ”¶å‚æ•°çš„å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨äº†ä¿å­˜çš„å˜é‡ï¼Œç„¶åå†è¿”å›å€¼ã€‚</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è¿™ä¸ªå‡½æ•°åº”è¯¥æ˜¯æ•´ä¸ªæºç ä¸­æœ€éš¾ç†è§£çš„ä¸€å—äº†</span>
<span class="token comment">// è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŸ¯é‡ŒåŒ–çš„å‡½æ•°</span>
<span class="token comment">// æ‰€ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°åº”è¯¥è¿™æ ·å†™ applyMiddleware(...middlewares)(createStore)(...args)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">createStore</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// è¿™é‡Œæ‰§è¡Œ createStore å‡½æ•°ï¼ŒæŠŠ applyMiddleware å‡½æ•°æœ€åæ¬¡è°ƒç”¨çš„å‚æ•°ä¼ è¿›æ¥</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Dispatching while constructing your middleware is not allowed. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Other middleware would not be applied to this dispatch.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// æ¯ä¸ªä¸­é—´ä»¶éƒ½åº”è¯¥æœ‰è¿™ä¸¤ä¸ªå‡½æ•°</span>
    <span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
      getState<span class="token punctuation">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
      <span class="token function-variable function">dispatch</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æŠŠ middlewares ä¸­çš„æ¯ä¸ªä¸­é—´ä»¶éƒ½ä¼ å…¥ middlewareAPI</span>
    chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// å’Œä¹‹å‰ä¸€æ ·ï¼Œä»å³è‡³å·¦è°ƒç”¨æ¯ä¸ªä¸­é—´ä»¶ï¼Œç„¶åä¼ å…¥ store.dispatch</span>
    dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
    <span class="token comment">// è¿™é‡Œåªçœ‹è¿™éƒ¨åˆ†ä»£ç æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘è¿™é‡Œæ”¾å…¥ redux-thunk çš„ä»£ç æ¥ç»“åˆåˆ†æ</span>
    <span class="token comment">// createThunkMiddlewareè¿”å›äº†3å±‚å‡½æ•°ï¼Œç¬¬ä¸€å±‚å‡½æ•°æ¥æ”¶ middlewareAPI å‚æ•°</span>
    <span class="token comment">// ç¬¬äºŒæ¬¡å‡½æ•°æ¥æ”¶ store.dispatch</span>
    <span class="token comment">// ç¬¬ä¸‰å±‚å‡½æ•°æ¥æ”¶ dispatch ä¸­çš„å‚æ•°</span>
<span class="token punctuation">{</span><span class="token keyword">function</span> <span class="token function">createThunkMiddleware</span><span class="token punctuation">(</span><span class="token parameter">extraArgument</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ dispatch ä¸­çš„å‚æ•°æ˜¯å¦ä¸ºå‡½æ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ˜¯å‡½æ•°çš„è¯å†æŠŠè¿™äº›å‚æ•°ä¼ è¿›å»ï¼Œç›´åˆ° action ä¸ä¸ºå‡½æ•°ï¼Œæ‰§è¡Œ dispatch({tyep: 'XXX'})</span>
      <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> extraArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> thunk <span class="token operator">=</span> <span class="token function">createThunkMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> thunk<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token comment">// æœ€åæŠŠç»è¿‡ä¸­é—´ä»¶åŠ å¼ºåçš„ dispatch äºå‰©ä½™ store ä¸­çš„å±æ€§è¿”å›ï¼Œè¿™æ ·ä½ çš„ dispatch</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>store<span class="token punctuation">,</span>
      dispatch
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¥½äº†ï¼Œæˆ‘ä»¬ç°åœ¨å°†å›°éš¾çš„éƒ¨åˆ†éƒ½æ”»å…‹äº†ï¼Œæ¥çœ‹ä¸€äº›ç®€å•çš„ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯æŠŠå½“å‰çš„ state è¿”å›ï¼Œä½†æ˜¯å½“æ­£åœ¨æ‰§è¡Œ reducer æ—¶ä¸èƒ½æ‰§è¡Œè¯¥æ–¹æ³•</span>
<span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'You may not call store.getState() while the reducer is executing. '</span> <span class="token operator">+</span>
          <span class="token string">'The reducer has already received the state as an argument. '</span> <span class="token operator">+</span>
          <span class="token string">'Pass it down from the top reducer instead of reading it from the store.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> currentState
<span class="token punctuation">}</span>
<span class="token comment">// æ¥æ”¶ä¸€ä¸ªå‡½æ•°å‚æ•°</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> listener <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected listener to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token comment">// è¿™éƒ¨åˆ†æœ€ä¸»è¦çš„è®¾è®¡ nextListeners å·²ç»è®²è¿‡ï¼Œå…¶ä»–åŸºæœ¬æ²¡ä»€ä¹ˆå¥½è¯´çš„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'You may not call store.subscribe() while the reducer is executing. '</span> <span class="token operator">+</span>
          <span class="token string">'If you would like to be notified after the store has been updated, subscribe from a '</span> <span class="token operator">+</span>
          <span class="token string">'component and invoke store.getState() in the callback to access the latest state. '</span> <span class="token operator">+</span>
          <span class="token string">'See http://redux.js.org/docs/api/Store.html#subscribe for more details.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> isSubscribed <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token function">ensureCanMutateNextListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    nextListeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>

<span class="token comment">// è¿”å›ä¸€ä¸ªå–æ¶ˆè®¢é˜…å‡½æ•°</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSubscribed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'You may not unsubscribe from a store listener while the reducer is executing. '</span> <span class="token operator">+</span>
            <span class="token string">'See http://redux.js.org/docs/api/Store.html#subscribe for more details.'</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      isSubscribed <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token function">ensureCanMutateNextListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> nextListeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
      nextListeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 
<span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// åŸç”Ÿçš„ dispatch ä¼šåˆ¤æ–­ action æ˜¯å¦ä¸ºå¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'Actions must be plain objects. '</span> <span class="token operator">+</span>
          <span class="token string">'Use custom middleware for async actions.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'Actions may not have an undefined &quot;type&quot; property. '</span> <span class="token operator">+</span>
          <span class="token string">'Have you misspelled a constant?'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token comment">// æ³¨æ„åœ¨ Reducers ä¸­æ˜¯ä¸èƒ½æ‰§è¡Œ dispatch å‡½æ•°çš„</span>
<span class="token comment">// å› ä¸ºä½ ä¸€æ—¦åœ¨ reducer å‡½æ•°ä¸­æ‰§è¡Œ dispatchï¼Œä¼šå¼•å‘æ­»å¾ªç¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDispatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Reducers may not dispatch actions.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token comment">// æ‰§è¡Œ combineReducers ç»„åˆåçš„å‡½æ•°</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      isDispatching <span class="token operator">=</span> <span class="token boolean">true</span>
      currentState <span class="token operator">=</span> <span class="token function">currentReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      isDispatching <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token comment">// ç„¶åéå† currentListenersï¼Œæ‰§è¡Œæ•°ç»„ä¸­ä¿å­˜çš„å‡½æ•°</span>
    <span class="token keyword">const</span> listeners <span class="token operator">=</span> <span class="token punctuation">(</span>currentListeners <span class="token operator">=</span> nextListeners<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> action
  <span class="token punctuation">}</span>
 <span class="token comment">// ç„¶ååœ¨ createStore æœ«å°¾ä¼šå‘èµ·ä¸€ä¸ª action dispatch({ type: ActionTypes.INIT });</span>
 <span class="token comment">// ç”¨ä»¥åˆå§‹åŒ– state</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a63f8372.js" defer></script><script src="/assets/js/2.f6583267.js" defer></script><script src="/assets/js/13.b9dfc02e.js" defer></script>
  </body>
</html>
